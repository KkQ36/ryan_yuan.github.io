[{"content":"å…³äº\næ²¿ç€ä¸ŠèŠ‚çš„æµç¨‹ï¼Œè¯¦ç»†çš„æ¥çœ‹çœ‹ wrapIfNecessary() æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) { if (StringUtils.hasLength(beanName) \u0026amp;\u0026amp; this.targetSourcedBeans.contains(beanName)) { return bean; } if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) { return bean; } if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) { this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; } // å¦‚æœè¯¥ç±»çš„ Advisor ä¸ä¸ºç©ºï¼Œåˆ›å»ºä»£ç†ç±» Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); if (specificInterceptors != DO_NOT_PROXY) { this.advisedBeans.put(cacheKey, Boolean.TRUE); Object proxy = createProxy( bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean)); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; } this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; } ä¸ç”Ÿæˆä»£ç†ç±»çš„æƒ…å†µ 1 2 3 4 5 6 7 8 9 10 if (StringUtils.hasLength(beanName) \u0026amp;\u0026amp; this.targetSourcedBeans.contains(beanName)) { return bean; } if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) { return bean; } if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) { this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; } ä»¥ä¸‹çš„å››ç§æƒ…å†µå°†ä¸ä¼šç”Ÿæˆä»£ç†ç±»ï¼š\nBeanName ä¸ä¸ºç©ºä¸”åœ¨ targetSourcedBeans é›†åˆä¸­ï¼Œç›´æ¥è¿”å›åŸå§‹ beanã€‚ AdvisedBeans ç¼“å­˜ä¸­å­˜åœ¨ cacheKey ä¸”å€¼ä¸º falseï¼Œç›´æ¥è¿”å›åŸå§‹ beanã€‚ Bean å±äºåŸºç¡€è®¾æ–½ç±»æˆ–æ»¡è¶³è·³è¿‡æ¡ä»¶ï¼Œå°† cacheKey æ ‡è®°ä¸º false å¹¶è¿”å›åŸå§‹ beanã€‚ æ²¡æœ‰ä¸ Bean åŒ¹é…çš„ Advisor è·å–é€‚é…ç±»çš„ Advisors 1 Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); org.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean(Class\u0026lt;?\u0026gt; beanClass, String beanName, @Nullable TargetSource targetSource)\n1 2 3 4 5 6 7 8 9 @Override @Nullable protected Object[] getAdvicesAndAdvisorsForBean(Class\u0026lt;?\u0026gt; beanClass, String beanName, @Nullable TargetSource targetSource) { List\u0026lt;Advisor\u0026gt; advisors = findEligibleAdvisors(beanClass, beanName); if (advisors.isEmpty()) { return DO_NOT_PROXY; } return advisors.toArray(); } org.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreator#findEligibleAdvisors(Class\u0026lt;?\u0026gt; beanClass, String beanName)\n1 2 3 4 5 6 7 8 9 protected List\u0026lt;Advisor\u0026gt; findEligibleAdvisors(Class\u0026lt;?\u0026gt; beanClass, String beanName) { List\u0026lt;Advisor\u0026gt; candidateAdvisors = findCandidateAdvisors(); List\u0026lt;Advisor\u0026gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName); extendAdvisors(eligibleAdvisors); if (!eligibleAdvisors.isEmpty()) { eligibleAdvisors = sortAdvisors(eligibleAdvisors); } return eligibleAdvisors; } é¦–å…ˆè°ƒç”¨ findCandidateAdvisors æ‹¿åˆ°æ‰€æœ‰çš„å€™é€‰è€… Advisorï¼Œå†è°ƒç”¨ findAdvisorsThatCanApply é€‰å‡ºé€‚é…è¯¥ Bean çš„ Advisorã€‚\næœ€ç»ˆä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼š org.springframework.aop.support.AopUtils#findAdvisorsThatCanApply(List\u0026lt;Advisor\u0026gt; candidateAdvisors, Class\u0026lt;?\u0026gt; clazz)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public static List\u0026lt;Advisor\u0026gt; findAdvisorsThatCanApply(List\u0026lt;Advisor\u0026gt; candidateAdvisors, Class\u0026lt;?\u0026gt; clazz) { if (candidateAdvisors.isEmpty()) { return candidateAdvisors; } List\u0026lt;Advisor\u0026gt; eligibleAdvisors = new ArrayList\u0026lt;\u0026gt;(); for (Advisor candidate : candidateAdvisors) { if (candidate instanceof IntroductionAdvisor \u0026amp;\u0026amp; canApply(candidate, clazz)) { eligibleAdvisors.add(candidate); } } boolean hasIntroductions = !eligibleAdvisors.isEmpty(); for (Advisor candidate : candidateAdvisors) { if (candidate instanceof IntroductionAdvisor) { // already processed continue; } if (canApply(candidate, clazz, hasIntroductions)) { eligibleAdvisors.add(candidate); } } return eligibleAdvisors; } è¿™ä¸ªæ–¹æ³• findAdvisorsThatCanApply ç”¨äºè¿‡æ»¤å’Œç­›é€‰å‡ºå¯ä»¥åº”ç”¨äºç‰¹å®šç›®æ ‡ç±» clazz çš„å¢å¼ºå™¨ï¼ˆAdvisorï¼‰ï¼Œå³ æ‰¾å‡ºä¸è¯¥ç±»åŒ¹é…çš„ Advisor åˆ—è¡¨ã€‚ é¦–å…ˆéå† candidateAdvisors åˆ—è¡¨ï¼Œç­›é€‰å‡ºæ‰€æœ‰çš„ IntroductionAdvisorã€‚ å¯¹äºæ¯ä¸ª IntroductionAdvisorï¼Œè°ƒç”¨ canApply(candidate, clazz) æ–¹æ³•åˆ¤æ–­å®ƒæ˜¯å¦é€‚ç”¨äºç›®æ ‡ç±» clazzã€‚ å¦‚æœé€‚ç”¨ï¼Œå°±å°†å®ƒæ·»åŠ åˆ° eligibleAdvisors åˆ—è¡¨ä¸­ã€‚ å†æ¬¡éå† candidateAdvisors åˆ—è¡¨ï¼Œæ’é™¤ IntroductionAdvisorï¼Œåªå¤„ç†æ™®é€šçš„ Advisorã€‚ å¯¹äºæ¯ä¸ªæ™®é€šçš„ Advisorï¼Œè°ƒç”¨ canApply(candidate, clazz, hasIntroductions) æ–¹æ³•æ£€æŸ¥å®ƒæ˜¯å¦é€‚ç”¨äºç›®æ ‡ç±» clazzã€‚ å¦‚æœé€‚ç”¨ï¼Œå°†å…¶æ·»åŠ åˆ° eligibleAdvisors åˆ—è¡¨ä¸­ã€‚\nåˆ›å»ºä»£ç†ç±» 1 2 3 4 5 6 7 if (specificInterceptors != DO_NOT_PROXY) { this.advisedBeans.put(cacheKey, Boolean.TRUE); Object proxy = createProxy( bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean)); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; } å¦‚æœ specificInterceptors ä¸ä¸º null å°±ä¼šå»åˆ›å»ºä»£ç†ï¼›\norg.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#createProxy(Class\u0026lt;?\u0026gt; beanClass, @Nullable String beanName, @Nullable Object[] specificInterceptors, TargetSource targetSource)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 protected Object createProxy(Class\u0026lt;?\u0026gt; beanClass, @Nullable String beanName, @Nullable Object[] specificInterceptors, TargetSource targetSource) { if (this.beanFactory instanceof ConfigurableListableBeanFactory) { AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) this.beanFactory, beanName, beanClass); } ProxyFactory proxyFactory = new ProxyFactory(); proxyFactory.copyFrom(this); if (proxyFactory.isProxyTargetClass()) { // Explicit handling of JDK proxy targets and lambdas (for introduction advice scenarios) if (Proxy.isProxyClass(beanClass) || ClassUtils.isLambdaClass(beanClass)) { // Must allow for introductions; can\u0026#39;t just set interfaces to the proxy\u0026#39;s interfaces only. for (Class\u0026lt;?\u0026gt; ifc : beanClass.getInterfaces()) { proxyFactory.addInterface(ifc); } } } else { // No proxyTargetClass flag enforced, let\u0026#39;s apply our default checks... if (shouldProxyTargetClass(beanClass, beanName)) { proxyFactory.setProxyTargetClass(true); } else { evaluateProxyInterfaces(beanClass, proxyFactory); } } Advisor[] advisors = buildAdvisors(beanName, specificInterceptors); proxyFactory.addAdvisors(advisors); proxyFactory.setTargetSource(targetSource); customizeProxyFactory(proxyFactory); proxyFactory.setFrozen(this.freezeProxy); if (advisorsPreFiltered()) { proxyFactory.setPreFiltered(true); } // Use original ClassLoader if bean class not locally loaded in overriding class loader ClassLoader classLoader = getProxyClassLoader(); if (classLoader instanceof SmartClassLoader \u0026amp;\u0026amp; classLoader != beanClass.getClassLoader()) { classLoader = ((SmartClassLoader) classLoader).getOriginalClassLoader(); } return proxyFactory.getProxy(classLoader); } è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸ºï¼šproxyFactory.getProxy(classLoader);ï¼Œå³è°ƒç”¨ proxyFactory çš„åˆ›å»ºä»£ç†æ–¹æ³•ã€‚\nä»£ç†å·¥å‚çš„åˆå§‹åŒ–é…ç½® æ•´ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯å¯¹ä»£ç†å·¥å‚çš„ä¸€ä¸ªæ„å»ºï¼Œåœ¨è°ƒç”¨ proxyFactory.copyFrom(this); ï¼Œä¼šå°† Creator çš„é…ç½®å¤åˆ¶åˆ°ä»£ç†å·¥å‚ä¸­ï¼š org.springframework.aop.framework.ProxyConfig#copyFrom(ProxyConfig other)\n1 2 3 4 5 6 7 8 public void copyFrom(ProxyConfig other) { Assert.notNull(other, \u0026#34;Other ProxyConfig object must not be null\u0026#34;); this.proxyTargetClass = other.proxyTargetClass; this.optimize = other.optimize; this.exposeProxy = other.exposeProxy; this.frozen = other.frozen; this.opaque = other.opaque; } proxyTargetSourceï¼šè®¾ç½®æ˜¯å¦ç›´æ¥ä»£ç†ç›®æ ‡ç±»ï¼Œè€Œä¸æ˜¯ä»…ä»£ç†ç‰¹å®šçš„æ¥å£ã€‚é»˜è®¤å€¼ä¸º \u0026ldquo;false\u0026rdquo;ã€‚\nå°†å…¶è®¾ç½®ä¸º \u0026ldquo;true\u0026rdquo; æ—¶ï¼Œä¼šå¼ºåˆ¶å¯¹ TargetSource æ‰€æš´éœ²çš„ç›®æ ‡ç±»è¿›è¡Œä»£ç†ã€‚ å¦‚æœç›®æ ‡ç±»æ˜¯ä¸€ä¸ªæ¥å£ï¼Œåˆ™ä¼šä¸ºè¯¥æ¥å£åˆ›å»ºä¸€ä¸ª JDK ä»£ç†ã€‚ å¦‚æœç›®æ ‡ç±»æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ï¼Œåˆ™ä¼šä¸ºè¯¥ç±»åˆ›å»ºä¸€ä¸ª CGLIB ä»£ç†ã€‚ optimizeï¼šè®¾ç½®ä»£ç†æ˜¯å¦åº”æ‰§è¡Œâ€œç§¯æä¼˜åŒ–â€ã€‚\nâ€œç§¯æä¼˜åŒ–â€çš„å…·ä½“å«ä¹‰å› ä»£ç†ç±»å‹è€Œå¼‚ï¼Œä½†é€šå¸¸ä¼šæ¶‰åŠæŸç§æƒè¡¡ï¼Œé»˜è®¤å€¼ä¸º \u0026ldquo;false\u0026rdquo;ã€‚ åœ¨ Spring å½“å‰çš„ä»£ç†é€‰é¡¹ä¸­ï¼Œæ­¤æ ‡å¿—å®é™…ä¸Šä¼šå¼ºåˆ¶ä½¿ç”¨ CGLIB ä»£ç†ï¼Œä½†ä¸ä¼šæ‰§è¡Œä»»ä½•ç±»éªŒè¯æ£€æŸ¥ï¼ˆå¦‚å¯¹ final æ–¹æ³•çš„æ£€æŸ¥ç­‰ï¼‰ã€‚ opaqueï¼šè®¾ç½®ç”±æ­¤é…ç½®åˆ›å»ºçš„ä»£ç†æ˜¯å¦åº”è¯¥ç¦æ­¢è¢«å¼ºåˆ¶è½¬æ¢ä¸º {@link Advised} ä»¥æŸ¥è¯¢ä»£ç†çŠ¶æ€ã€‚\né»˜è®¤å€¼ä¸º \u0026ldquo;false\u0026rdquo;ï¼Œè¿™æ„å‘³ç€ä»»ä½• AOP ä»£ç†éƒ½å¯ä»¥è¢«å¼ºåˆ¶è½¬æ¢ä¸º {@link Advised}ã€‚ frozenï¼šå†³å®šä»£ç†çš„é…ç½®æ˜¯å¦å¯ä»¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œé…ç½®æ˜¯å¯å˜çš„ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡å°†ä»£ç†è½¬æ¢ä¸º Advised æ¥å£æ¥ä¿®æ”¹é€šçŸ¥é“¾æˆ–å…¶ä»–é…ç½®ã€‚ å½“å…¶è®¾ç½®ä¸º true çš„æ—¶å€™ï¼š é…ç½®è¢«é”å®šï¼Œä¸èƒ½å†åŠ¨æ€æ›´æ”¹é€šçŸ¥æˆ–åˆ‡é¢é…ç½®ã€‚ å¢å¼ºç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œå› ä¸ºä»£ç†ä¸éœ€è¦æ”¯æŒåŠ¨æ€ä¿®æ”¹ã€‚ æ ¹æ®æ˜¯å¦ä»£ç†ç›®æ ‡ç±»æ‰§è¡Œä¸åŒçš„æ“ä½œ å¯¹åº”æºç çš„è¿™ä¸€éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 if (proxyFactory.isProxyTargetClass()) { // Explicit handling of JDK proxy targets and lambdas (for introduction advice scenarios) if (Proxy.isProxyClass(beanClass) || ClassUtils.isLambdaClass(beanClass)) { // Must allow for introductions; can\u0026#39;t just set interfaces to the proxy\u0026#39;s interfaces only. for (Class\u0026lt;?\u0026gt; ifc : beanClass.getInterfaces()) { proxyFactory.addInterface(ifc); } } } else { // No proxyTargetClass flag enforced, let\u0026#39;s apply our default checks... if (shouldProxyTargetClass(beanClass, beanName)) { proxyFactory.setProxyTargetClass(true); } else { evaluateProxyInterfaces(beanClass, proxyFactory); } } ä¸Šé¢æˆ‘ä»¬æåˆ°ï¼ŒproxyTargetSourceï¼šè®¾ç½®æ˜¯å¦ç›´æ¥ä»£ç†ç›®æ ‡ç±»ï¼Œè€Œä¸æ˜¯ä»…ä»£ç†ç‰¹å®šçš„æ¥å£ã€‚é»˜è®¤å€¼ä¸º \u0026ldquo;false\u0026rdquo;ã€‚ å¦‚æœä¸º true çš„è¯ï¼Œå¯¹ JDK ä»£ç†ç±»å’Œ lambda æ¥å£çš„å®ç°ç±»åšä¸€äº›ç‰¹æ®Šçš„å¤„ç†ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜æ¥å£çš„ç±»å‹ã€‚ å¦‚æœè®¾ç½®ä¸º false çš„è¯ï¼Œæ‰§è¡Œé»˜è®¤çš„æ“ä½œ é¦–å…ˆæ£€æŸ¥ Bean å®šä¹‰ä¸­æ˜¯å¦æ˜ç¡®åˆ¶å®šäº†éœ€è¦ä»£ç†ç±»è€Œä¸æ˜¯æ¥å£ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°† proxyTargetSource è®¾ç½®ä¸º trueã€‚ åä¹‹è°ƒç”¨ evaluateProxyInterfacesï¼Œè¯„ä¼° Bean æ˜¯å¦æœ‰å®ç°çš„æ¥å£ï¼Œæˆ‘ä»¬è¯´çš„å¦‚æœ ä»£ç†ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œä½¿ç”¨ CgLib ä»£ç†ï¼Œåä¹‹ï¼Œä½¿ç”¨ JDK ä»£ç†æ­£æ˜¯è¿™ä¸ªæ–¹æ³•çš„åŸå› ã€‚\nå…¨é™å®šåï¼šorg.springframework.aop.framework.ProxyProcessorSupport#evaluateProxyInterfaces(Class\u0026lt;?\u0026gt; beanClass, ProxyFactory proxyFactory) æ–¹æ³•æ³¨é‡Šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /** * Check the interfaces on the given bean class and apply them to the {@link ProxyFactory}, * if appropriate. * \u0026lt;p\u0026gt;Calls {@link #isConfigurationCallbackInterface} and {@link #isInternalLanguageInterface} * to filter for reasonable proxy interfaces, falling back to a target-class proxy otherwise. * @param beanClass the class of the bean * @param proxyFactory the ProxyFactory for the bean */ /** * æ£€æŸ¥ç»™å®š Bean ç±»ä¸Šçš„æ¥å£ï¼Œå¹¶åœ¨åˆé€‚çš„æƒ…å†µä¸‹å°†è¿™äº›æ¥å£åº”ç”¨åˆ° {@link ProxyFactory}ã€‚ * * \u0026lt;p\u0026gt;ä¼šè°ƒç”¨ {@link #isConfigurationCallbackInterface} å’Œ {@link #isInternalLanguageInterface} * æ–¹æ³•æ¥è¿‡æ»¤å‡ºåˆç†çš„ä»£ç†æ¥å£ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆç†çš„æ¥å£ï¼Œåˆ™ä¼šé€€å›åˆ°åŸºäºç›®æ ‡ç±»ï¼ˆtarget-classï¼‰çš„ä»£ç†ã€‚ * * @param beanClass Bean çš„ç±» * @param proxyFactory ç”¨äºåˆ›å»ºä»£ç†çš„ {@link ProxyFactory} */ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 protected void evaluateProxyInterfaces(Class\u0026lt;?\u0026gt; beanClass, ProxyFactory proxyFactory) { Class\u0026lt;?\u0026gt;[] targetInterfaces = ClassUtils.getAllInterfacesForClass(beanClass, getProxyClassLoader()); boolean hasReasonableProxyInterface = false; for (Class\u0026lt;?\u0026gt; ifc : targetInterfaces) { if (!isConfigurationCallbackInterface(ifc) \u0026amp;\u0026amp; !isInternalLanguageInterface(ifc) \u0026amp;\u0026amp; ifc.getMethods().length \u0026gt; 0) { hasReasonableProxyInterface = true; break; } } if (hasReasonableProxyInterface) { // Must allow for introductions; can\u0026#39;t just set interfaces to the target\u0026#39;s interfaces only. for (Class\u0026lt;?\u0026gt; ifc : targetInterfaces) { proxyFactory.addInterface(ifc); } } else { proxyFactory.setProxyTargetClass(true); } } è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä»ç›®æ ‡ç±»ï¼ˆbeanClassï¼‰ä¸­æå–éœ€è¦ä»£ç†çš„æ¥å£ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°ä»£ç†å·¥å‚ï¼ˆProxyFactoryï¼‰ä¸­ï¼Œè€Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ¥å£ï¼ˆå³æ‰€æœ‰æ¥å£éƒ½è¢«è¿‡æ»¤æ‰ï¼‰ï¼Œåˆ™ä¼šä½¿ç”¨ç›®æ ‡ç±»è¿›è¡Œä»£ç†ï¼ˆå³å¯ç”¨ CGLIB åŠ¨æ€ä»£ç†ï¼‰ã€‚ ä½¿ç”¨ isConfigurationCallbackInterface å’Œ isInternalLanguageInterface æ–¹æ³•å¯¹æ¥å£è¿›è¡Œç­›é€‰ï¼Œç¡®ä¿åªä»£ç†åˆç†çš„æ¥å£ã€‚\nåˆç†çš„æ¥å£é€šå¸¸æ˜¯ç”¨æˆ·å®šä¹‰çš„æ¥å£ï¼Œè€Œé Spring å†…éƒ¨ä½¿ç”¨çš„å›è°ƒæ¥å£æˆ–ä¸è¯­è¨€æœºåˆ¶ç›¸å…³çš„å†…éƒ¨æ¥å£ã€‚ è¿™ä¸¤ä¸ªæ–¹æ³•å°†è¿™äº›æ¥å£æ’é™¤åœ¨å¤–ï¼š 1 2 3 4 5 6 7 8 9 protected boolean isConfigurationCallbackInterface(Class\u0026lt;?\u0026gt; ifc) { return (InitializingBean.class == ifc || DisposableBean.class == ifc || Closeable.class == ifc || AutoCloseable.class == ifc || ObjectUtils.containsElement(ifc.getInterfaces(), Aware.class)); } protected boolean isInternalLanguageInterface(Class\u0026lt;?\u0026gt; ifc) { return (ifc.getName().equals(\u0026#34;groovy.lang.GroovyObject\u0026#34;) || ifc.getName().endsWith(\u0026#34;.cglib.proxy.Factory\u0026#34;) || ifc.getName().endsWith(\u0026#34;.bytebuddy.MockAccess\u0026#34;)); } å¦‚æœç­›é€‰åæ²¡æœ‰é€‚åˆçš„æ¥å£ï¼Œåˆ™ä¼šå›é€€åˆ°åŸºäºç›®æ ‡ç±»çš„ä»£ç†æ–¹å¼ï¼ˆ è§¦å‘ CGLIB åŠ¨æ€ä»£ç† ï¼‰ã€‚\nå¡«å……ä»£ç†å·¥å‚çš„å…¶ä»–å±æ€§ å¯¹åº”æºç çš„è¿™ä¸€éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Advisor[] advisors = buildAdvisors(beanName, specificInterceptors); proxyFactory.addAdvisors(advisors); proxyFactory.setTargetSource(targetSource); customizeProxyFactory(proxyFactory); proxyFactory.setFrozen(this.freezeProxy); if (advisorsPreFiltered()) { proxyFactory.setPreFiltered(true); } // Use original ClassLoader if bean class not locally loaded in overriding class loader ClassLoader classLoader = getProxyClassLoader(); if (classLoader instanceof SmartClassLoader \u0026amp;\u0026amp; classLoader != beanClass.getClassLoader()) { classLoader = ((SmartClassLoader) classLoader).getOriginalClassLoader(); } è·å–å¹¶æ„å»ºä¸€ä¸ª Advisor åˆ—è¡¨ï¼Œè¿™ä¸ª specificInterceptors æ˜¯ä» wrapIfNecessoryä¸­ä¼ é€’ä¸‹æ¥çš„ï¼Œç„¶åå°†è¿™äº› Advisor æ·»åŠ åˆ°ä»£ç†å·¥å‚ã€‚ Spring ä½¿ç”¨ SmartClassLoader æ£€æµ‹ç›®æ ‡ç±»çš„ç±»åŠ è½½å™¨å’Œä»£ç†ç±»çš„ç±»åŠ è½½å™¨æ˜¯å¦ä¸€è‡´ï¼š å¦‚æœä»£ç†ç±»çš„ç±»åŠ è½½å™¨ä¸ç›®æ ‡ç±»ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç±»åŠ è½½é—®é¢˜ï¼Œå› æ­¤ Spring ä¼šå°è¯•è°ƒæ•´ä½¿ç”¨çš„ç±»åŠ è½½å™¨ã€‚\næ­£å¼å¼€å§‹åˆ›å»ºä»£ç†ç±» 1 return proxyFactory.getProxy(classLoader); å…¶æœ€ç»ˆä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼š\nå…¨é™å®šåï¼šorg.springframework.aop.framework.DefaultAopProxyFactory#createAopProxy(AdvisedSupport config) æ¥å£å®šä¹‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /** * Create an {@link AopProxy} for the given AOP configuration. * @param config the AOP configuration in the form of an * AdvisedSupport object * @return the corresponding AOP proxy * @throws AopConfigException if the configuration is invalid */ /** * ä¸ºç»™å®šçš„ AOP é…ç½®åˆ›å»ºä¸€ä¸ª {@link AopProxy} å®ä¾‹ã€‚ * * @param config ä»¥ {@link AdvisedSupport} å¯¹è±¡å½¢å¼è¡¨ç¤ºçš„ AOP é…ç½®ä¿¡æ¯ * @return å¯¹åº”çš„ AOP ä»£ç† * @throws AopConfigException å¦‚æœé…ç½®æ— æ•ˆï¼Œåˆ™æŠ›å‡ºæ­¤å¼‚å¸¸ / 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException { if (!NativeDetector.inNativeImage() \u0026amp;\u0026amp; (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config))) { Class\u0026lt;?\u0026gt; targetClass = config.getTargetClass(); if (targetClass == null) { throw new AopConfigException(\u0026#34;TargetSource cannot determine target class: \u0026#34; + \u0026#34;Either an interface or a target is required for proxy creation.\u0026#34;); } if (targetClass.isInterface() || Proxy.isProxyClass(targetClass) || ClassUtils.isLambdaClass(targetClass)) { return new JdkDynamicAopProxy(config); } return new ObjenesisCglibAopProxy(config); } else { return new JdkDynamicAopProxy(config); } } ä¼ å…¥çš„å‚æ•° AdvisedSupport å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ„å»ºçš„ä»£ç†å·¥å‚ï¼Œå…¶å®ç°äº† AdvisedSupport æ¥å£ã€‚ æˆ‘ä»¬å†æ¥æ¢³ç†ä¸€ä¸‹è¿™ä¸ªé…ç½®ä¸­å¯¹ä¸€äº›å€¼ï¼š\nisOptimizeï¼šé»˜è®¤ falseï¼Œä¸è¿›è¡Œæ™ºèƒ½ä»£ç†ä¼˜åŒ– isProxyTargetClassï¼šç±»æˆ–è€…Creator æŒ‡å®šéœ€è¦ä»£ç†çš„æ˜¯ç›®æ ‡ç±» æˆ– ç±»æ²¡æœ‰å®ç°ä»»ä½•å¯ç”¨æ¥å£ æ—¶ä¸º trueï¼Œå…¶ä»–æ—¶å€™ä¸º false åˆ›å»º CgLib ä»£ç†ç±» å¯¹åº”æºç çš„è¿™ä¸€éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 if (!NativeDetector.inNativeImage() \u0026amp;\u0026amp; (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config))) { Class\u0026lt;?\u0026gt; targetClass = config.getTargetClass(); if (targetClass == null) { throw new AopConfigException(\u0026#34;TargetSource cannot determine target class: \u0026#34; + \u0026#34;Either an interface or a target is required for proxy creation.\u0026#34;); } if (targetClass.isInterface() || Proxy.isProxyClass(targetClass) || ClassUtils.isLambdaClass(targetClass)) { return new JdkDynamicAopProxy(config); } return new ObjenesisCglibAopProxy(config); } !NativeDetector.inNativeImage() ç”¨äºæ£€æµ‹å½“å‰ç¯å¢ƒèƒ½å¦ä½¿ç”¨ CgLib ä»£ç†ï¼Œå¦‚æœå…è®¸çš„è¯ï¼Œä¸‹é¢çš„æ¡ä»¶ç¬¦åˆä»»æ„ä¸€æ¡éƒ½ä¼šå‡ºå‘ CgLib ä»£ç†ï¼š\nisOptimize æ™ºèƒ½ä»£ç†ä¼˜åŒ– isProxyTargetClass éœ€è¦ä»£ç†ç›®æ ‡ç±» hasNoUserSuppliedProxyInterfacesï¼Œæ£€æµ‹æ¥å£ï¼Œå¦‚æœå‘ç°ç”¨æˆ·æ²¡æœ‰æä¾›ä»»ä½•è‡ªå®šä¹‰æ¥å£ï¼ŒSpring å¯èƒ½ä¼šé€‰æ‹©ä½¿ç”¨ CGLIB ä»£ç†ã€‚ è¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„æƒ…å†µï¼Œåˆ›å»ºçš„æ˜¯ JDK ä»£ç†ç±»ï¼Œè¿™ä¸ªæ”¾åˆ°ä¸‹é¢å»è¯´ã€‚ åˆ›å»º JDK ä»£ç†ç±» å½“ä¸‹é¢çš„æ¡ä»¶ä¸ç¬¦åˆ\n1 !NativeDetector.inNativeImage() \u0026amp;\u0026amp; (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) æˆ–è€…ä»£ç†çš„ç±»æ˜¯ä¸€ä¸ªæ¥å£ã€ä»£ç†çš„ç±»å·²ç»æ˜¯ä¸€ä¸ª JDK ä»£ç†ç±»ã€ä»£ç†çš„ç±»æ˜¯ä¸€ä¸ª lambda è¡¨è¾¾å¼çš„å®ç°ç±»\n1 targetClass.isInterface() || Proxy.isProxyClass(targetClass) || ClassUtils.isLambdaClass(targetClass) çš„æ—¶å€™ï¼Œä¼šåˆ›å»º JDK ä»£ç†ç±»ã€‚\n","date":"2024-11-17T00:00:00Z","image":"http://localhost:60831/p/spring-aop-%E4%BB%A3%E7%90%86%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95%E8%A7%A3%E6%9E%90/image_hu15123054864233634991.png","permalink":"http://localhost:60831/p/spring-aop-%E4%BB%A3%E7%90%86%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95%E8%A7%A3%E6%9E%90/","title":"Spring AOP ä»£ç†ç±»åˆ›å»ºæ–¹æ³•è§£æ"},{"content":"è¿™éƒ¨åˆ†æˆ‘ä»¬æ¥å…·ä½“çš„çœ‹ä¸€ä¸‹ Spring AOP å®ç°ä¸­ï¼Œä»£ç†ç±»ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ—¶å€™è¢«æ„å»ºçš„ã€‚\næ¡ˆä¾‹å‡†å¤‡ maven pom æ–‡ä»¶ spring.versionï¼š5.3.22 java.versionï¼š1.8 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;!-- Springæ ¸å¿ƒåº“ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Spring IoCå®¹å™¨ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-beans\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Springä¸Šä¸‹æ–‡æ”¯æŒï¼Œæä¾›äº†BeanFactoryçš„æ‰©å±• --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-context\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; Service æ¥å£ä¸å®ç°ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public interface IUserService { void queryUserName(String uId); void queryUserId(String name); } public class UserService implements IUserService { @Override public void queryUserName(String uId) { System.out.println(\u0026#34;æŸ¥è¯¢ç”¨æˆ·åç§°ä¸ºï¼šryan\u0026#34;); } @Override public void queryUserId(String name) { System.out.println(\u0026#34;æŸ¥è¯¢ç”¨æˆ·IDä¸ºï¼š10001\u0026#34;); } } é€šçŸ¥ç±» 1 2 3 4 5 6 7 8 9 10 11 public class LogAdvices { public void before() { System.out.println(\u0026#34;before\u0026#34;); } public void after() { System.out.println(\u0026#34;after\u0026#34;); } } ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæœ¬æ–‡æ‰€æœ‰çš„ Bean éƒ½ä¼šé€šè¿‡é…ç½®æ–‡ä»¶æ¥é…ç½®ã€‚ Main æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 public class Main { public static void main(String[] args) { ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext(\u0026#34;spring-aop.xml\u0026#34;); IUserService service = applicationContext.getBean(\u0026#34;userService\u0026#34;, IUserService.class); System.out.println(service.getClass()); service.queryUserName(\u0026#34;10001\u0026#34;); } } spring xml é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;beans xmlns=\u0026#34;http://www.springframework.org/schema/beans\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:aop=\u0026#34;http://www.springframework.org/schema/aop\u0026#34; xsi:schemaLocation=\u0026#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop https://www.springframework.org/schema/aop/spring-aop.xsd\u0026#34;\u0026gt; \u0026lt;bean id=\u0026#34;userService\u0026#34; class=\u0026#34;com.ryan.aop_test.service.impl.UserService\u0026#34;/\u0026gt; \u0026lt;bean id=\u0026#34;logAspect\u0026#34; class=\u0026#34;com.ryan.aop_test.LogAdvices\u0026#34; /\u0026gt; \u0026lt;aop:config\u0026gt; \u0026lt;aop:pointcut id=\u0026#34;point1\u0026#34; expression=\u0026#34;execution(* com.ryan.aop_test.service.*.*(..))\u0026#34; /\u0026gt; \u0026lt;aop:aspect ref=\u0026#34;logAspect\u0026#34;\u0026gt; \u0026lt;aop:before method=\u0026#34;before\u0026#34; pointcut-ref=\u0026#34;point1\u0026#34;/\u0026gt; \u0026lt;aop:after-returning method=\u0026#34;after\u0026#34; pointcut-ref=\u0026#34;point1\u0026#34; /\u0026gt; \u0026lt;/aop:aspect\u0026gt; \u0026lt;/aop:config\u0026gt; \u0026lt;/beans\u0026gt; å…³äº spring é€šè¿‡ xml é…ç½® aop çš„å…·ä½“å†…å®¹å¯ä»¥å‚ç…§å®˜ç½‘ï¼š\næ–‡æ¡£åœ°å€ï¼šhttps://docs.spring.io/spring-framework/docs/5.2.25.RELEASE/spring-framework-reference/core.html#aop-schema éœ€è¦æ³¨æ„ï¼Œè¿™ç§æ–¹å¼ä½¿ç”¨çš„æ˜¯ Spring çš„è‡ªåŠ¨ä»£ç†æœºåˆ¶ï¼Œå¦‚æœæœ‰ç±»ä¼¼ BeanNameAutoProxyCreator æˆ–ç±»ä¼¼çš„ç±»ä½¿ç”¨äº†æ˜¾ç¤ºçš„ä»£ç†ï¼Œä¼šå¯¼è‡´å…¶ä¸­çš„æŸä¸€é¡¹å¤±æ•ˆã€‚ å»ºè®®çš„ä½¿ç”¨æ–¹å¼æ˜¯ä»…ä½¿ç”¨\u0026lt;aop:config\u0026gt;æ ·å¼æˆ–ä»…ä½¿ç”¨AutoProxyCreatoræ ·å¼ï¼Œå¹¶ä¸”åˆ‡å‹¿æ··åˆä½¿ç”¨å®ƒä»¬ã€‚\næ‰§è¡Œç»“æœ å…ˆæ¥çœ‹ä¸€ä¸‹ä¸Šé¢çš„ Main æ–¹æ³•æ‰§è¡Œåçš„æ•ˆæœï¼š\n1 2 3 4 class com.sun.proxy.$Proxy3 before æŸ¥è¯¢ç”¨æˆ·åç§°ä¸ºï¼šryan after å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è·å–åˆ°çš„ç±»æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œå¹¶ä¸”ä»£ç†æ–¹æ³•å·²ç»æ‰§è¡ŒæˆåŠŸäº†ã€‚\næºç åˆ†æ XML è§£æ å½“æ‰§è¡Œä¸‹é¢è¿™æ¡è¯­å¥ä¹‹åï¼š\n1 ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext(\u0026#34;spring-aop.xml\u0026#34;); ä¼šæ‰§è¡Œ ClassPathXmlApplicationContext çš„ refresh æ–¹æ³•ï¼š org.springframework.context.support.AbstractApplicationContext#refresh()\n1 2 3 4 5 6 7 8 9 10 11 12 13 @Override public void refresh() throws BeansException, IllegalStateException { synchronized (this.startupShutdownMonitor) { StartupStep contextRefresh = this.applicationStartup.start(\u0026#34;spring.context.refresh\u0026#34;); // Prepare this context for refreshing. prepareRefresh(); // Tell the subclass to refresh the internal bean factory. ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // ...... } å…¶ä¸­ obtainFreshBeanFactory ä¼šæ‰§è¡Œ Bean å·¥å‚çš„åˆå§‹åŒ–ï¼Œå…¶ä¸­æœ€é‡è¦çš„éƒ¨åˆ†å°±æ˜¯å°† XML é…ç½®æ–‡ä»¶ä¸­çš„ Bean å®šä¹‰ï¼ˆBean Definitionï¼‰åŠ è½½åˆ° Bean å·¥å‚ä¸­ã€‚\n1 2 3 4 5 6 org.springframework.context.support.AbstractApplicationContext#refresh() =\u0026gt; org.springframework.context.support.AbstractRefreshableApplicationContext#refreshBeanFactory() =\u0026gt; org.springframework.context.support.AbstractXmlApplicationContext#loadBeanDefinitions(DefaultListableBeanFactory beanFactory) ä¸Šé¢çš„æ˜¯ä» `refresh()` æ–¹æ³•åˆ°å…·ä½“åŠ è½½ Bean Definition æ–¹æ³•çš„è°ƒç”¨é“¾è·¯ã€‚ org.springframework.context.support.AbstractXmlApplicationContext#loadBeanDefinitions(DefaultListableBeanFactory beanFactory) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Override protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException { // Create a new XmlBeanDefinitionReader for the given BeanFactory. XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); // Configure the bean definition reader with this context\u0026#39;s // resource loading environment. beanDefinitionReader.setEnvironment(this.getEnvironment()); beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); // Allow a subclass to provide custom initialization of the reader, // then proceed with actually loading the bean definitions. initBeanDefinitionReader(beanDefinitionReader); loadBeanDefinitions(beanDefinitionReader); } å…·ä½“è§£æ XML å’ŒåŠ è½½ Bean Definition çš„æ–¹æ³• å…³äºå…·ä½“æ˜¯å¦‚ä½•è§£æ XML çš„ï¼Œè¿™é‡Œå°±ä¸ç»†çœ‹äº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä¸€ä¸‹ä»æˆ‘ä»¬çš„ XML é…ç½®æ–‡ä»¶ä¸­å¯ä»¥è§£æåˆ°ä»€ä¹ˆ é…ç½®æ–‡ä»¶ï¼š[[ğŸ—ºï¸ã€spring-aopã€‘Spring ä»£ç†ç±»åˆ›å»ºæµç¨‹æ¢³ç†#spring xml é…ç½®æ–‡ä»¶]]\n1 2 3 4 5 6 7 beanDefinitionNames = {ArrayList@1626} size = 6 0 = \u0026#34;userService\u0026#34; 1 = \u0026#34;logAspect\u0026#34; 2 = \u0026#34;org.springframework.aop.config.internalAutoProxyCreator\u0026#34; 3 = \u0026#34;point1\u0026#34; 4 = \u0026#34;org.springframework.aop.aspectj.AspectJPointcutAdvisor#0\u0026#34; 5 = \u0026#34;org.springframework.aop.aspectj.AspectJPointcutAdvisor#1\u0026#34; é™¤äº†è¿™äº› infrastructureï¼Œä¸Šé¢è¿˜æœ‰ä¸€ä¸ª åç§° ä¸ºorg.springframework.aop.config.internalAutoProxyCreator çš„ Beanã€‚ è¿™ä¸ª Bean çš„å®é™…ç±»å‹æ˜¯ï¼šorg.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreatorï¼Œå®ƒæ˜¯ä¸€ä¸ª InstantiationAwareBeanPostProcessorï¼ŒAbstractAdvisorAutoProxyCreator ç±»å®ç°äº†ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼š\n1 2 3 default Object postProcessBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName) throws BeansException { return null; } è¿™ä¸ªæ–¹æ³•ä¼šåœ¨ Bean çš„å®ä¾‹åŒ–å‰è¢«è°ƒç”¨ï¼Œå¯ä»¥ç”¨äºä¿®æ”¹å’Œåˆ›å»º Bean å¯¹è±¡ã€‚ é™¤æ­¤ä¹‹å¤–ï¼ŒAbstractAdvisorAutoProxyCreator è¿˜å®ç°äº† BeanPostProcessor æ¥å£çš„ postProcessAfterInitializationï¼Œåœ¨ Bean å¯¹è±¡æ‰§è¡Œå®Œåˆå§‹åŒ–æ–¹æ³•åï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ£€æµ‹æ˜¯å¦éœ€è¦å°†å…¶è½¬åŒ–ä¸ºä»£ç†å¯¹è±¡ã€‚ AbstractAdvisorAutoProxyCreator æ˜¯ AOP ä»£ç†ä¸­éå¸¸å…³é”®çš„ä¸€ä¸ªç±»ï¼Œæ•´ä¸ªåˆ›å»º AOP ä»£ç†çš„æ ¸å¿ƒæµç¨‹å°±æ˜¯å…¶æ‰§è¡Œçš„è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚\nåŠ è½½ Creator ä¸Šé¢æåˆ°ï¼Œorg.springframework.aop.config.internalAutoProxyCreator æ˜¯ä¸€ä¸ª BeanPostProcessorï¼Œé‚£å®ƒå…·ä½“åˆ›å»ºå¹¶æ³¨å†Œçš„ä½ç½®å°±æ˜¯ï¼š org.springframework.context.support#registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„ä½ç½®è¿˜æ˜¯ ApplicationContext çš„ refresh() æ–¹æ³•ï¼Œå…·ä½“çš„è°ƒç”¨é“¾è·¯ä¸ºï¼š\n1 2 3 org.springframework.context.support.AbstractApplicationContext#refresh() =\u0026gt; org.springframework.context.support.AbstractApplicationContext#registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) =\u0026gt; org.springframework.context.support.PostProcessorRegistrationDelegate#registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) å…·ä½“å°±æ˜¯å°† BeanPostProcessor åŠ è½½åˆ°å·¥å‚ä¸­ï¼Œæ–¹ä¾¿åç»­çš„è°ƒç”¨ã€‚ å…·ä½“å­˜æ”¾ BeanPostProcessor çš„ä½ç½®ä¸ºï¼šorg.springframework.beans.factory.support.AbstractBeanFactory çš„ beanPostProcessors å±æ€§ã€‚\nåŠ è½½ Advisors åœ¨ã€ŒXML è§£æã€éƒ¨åˆ†ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† spring ä¸ºæˆ‘ä»¬å°† xml ä¸­å®šä¹‰çš„ \u0026lt;acp:config /\u0026gt; è§£æä¸ºå…·ä½“çš„ Bean å®šä¹‰ã€‚ å¹¶ä¸”åœ¨ã€ŒåŠ è½½ Creatorã€éƒ¨åˆ†ï¼Œspring å·²ç»å°† AOP åˆ›å»ºè€…ç±»æ³¨å†Œæˆäº†ä¸€ä¸ª InstantiationAwareBeanPostProcessorã€‚ åœ¨å°†å•ä¾‹ Beanï¼ˆåŸå‹ Bean ä¹Ÿå¯ä»¥è¢«ä»£ç†ï¼Œæœ¬æ–‡åªå…³æ³¨å•ä¾‹ Bean çš„ä»£ç†è¿‡ç¨‹ï¼‰åŠ è½½ä»£ç†ä¹‹å‰ï¼Œè‚¯å®šæ˜¯è¦å°†ä¸Šé¢ \u0026lt;acp:config /\u0026gt; ä¸­é…ç½®çš„ Bean æ„å»ºå‡ºæ¥çš„ã€‚ è€Œå¦‚æœæŒ‰ç…§æˆ‘ä»¬åœ¨ xml ä¸­é…ç½®çš„æ–¹å¼ï¼Œæ˜¾ç„¶å…ˆæ„å»ºçš„ Bean å°†ä¼šæ˜¯ userServiceã€‚ æ‰€ä»¥åœ¨æ‰€æœ‰çš„ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿è¿™äº›æ„å»º AOP çš„ infrastructure è¢«æå‰æ„å»ºå¥½ï¼Œè¿™å°±æ˜¯ AbstractAdvisorAutoProxyCreator åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œçš„é€»è¾‘ã€‚ æˆ‘ä»¬ä¾ç„¶ä» refresh() æ–¹æ³•å¼€å§‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 org.springframework.context.support.AbstractApplicationContext#refresh() =\u0026gt; org.springframework.context.support.AbstractApplicationContext#finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) =\u0026gt; org.springframework.beans.factory.support.DefaultListableBeanFactory#preInstantiateSingletons() åœ¨é¢„å…ˆå®ä¾‹åŒ–å•ä¾‹ Bean çš„æ–¹æ³•ä¸­ï¼Œä¼šå¯¹æ‰€æœ‰çš„ Bean æ‰§è¡Œ `getBean()` æ–¹æ³•ï¼Œ`getBean()` æ–¹æ³•å¦‚æœå‘ç° Bean æ²¡æœ‰è¢«åŠ è½½æˆ–è€…ä¸ºåŸå‹ Beanï¼Œå°†ä¼šè§¦å‘ Bean çš„åŠ è½½ã€‚ =\u0026gt; org.springframework.beans.factory.support.AbstractBeanFactory.getBean(String name) =\u0026gt; org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(String name, @Nullable Class\u0026lt;T\u0026gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly) =\u0026gt; org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) Bean çš„ `createBean()` æ–¹æ³•å®é™…ä¸Šæ˜¯å»¶è¿Ÿè°ƒç”¨çš„ï¼Œåç»­åœ¨ spring ä¸‰çº§ç¼“å­˜ä¸­ä¼šå…·ä½“è®²è§£ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥è§†ä¸ºç›´æ¥è°ƒç”¨äº† `createBean() æ–¹æ³• =\u0026gt; org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd) =\u0026gt; org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName) è¿™é‡Œå°±æ˜¯å…·ä½“æ‰§è¡Œ BeanPostProcessor çš„ä½ç½®ï¼š\n1 2 3 4 5 6 7 8 9 protected Object applyBeanPostProcessorsBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName) { for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) { Object result = bp.postProcessBeforeInstantiation(beanClass, beanName); if (result != null) { return result; } } return null; } åœ¨è¿™é‡Œä¼šéå†æ‰€æœ‰çš„ BeanPostProcessorï¼Œç„¶åè°ƒç”¨å…¶ postProcessBeforeInstantiationï¼Œä¸Šé¢çš„ AbstractAdvisorAutoProxyCreator çš„è¯¥æ–¹æ³•å°±æ˜¯åœ¨è¿™é‡Œè°ƒç”¨çš„ã€‚\norg.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#postProcessBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 @Override public Object postProcessBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName) { Object cacheKey = getCacheKey(beanClass, beanName); if (!StringUtils.hasLength(beanName) || !this.targetSourcedBeans.contains(beanName)) { if (this.advisedBeans.containsKey(cacheKey)) { return null; } if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) { this.advisedBeans.put(cacheKey, Boolean.FALSE); return null; } } // å¦‚æœæœ‰è‡ªå®šä¹‰çš„ TargetSourceï¼Œåˆ™åœ¨è¿™é‡Œåˆ›å»ºä»£ç†å¯¹è±¡ TargetSource targetSource = getCustomTargetSource(beanClass, beanName); if (targetSource != null) { if (StringUtils.hasLength(beanName)) { this.targetSourcedBeans.add(beanName); } Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource); Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; } return null; } åœ¨ä¸Šé¢çš„ shouldSkip() æ–¹æ³•ä¸­ï¼Œä¼šå°è¯•å»è·å–æ‰€æœ‰çš„ Advisorï¼Œæœªåˆ›å»ºçš„è¯ï¼Œåˆ™ä¼šå»å°è¯•åˆ›å»ºè¿™äº› Advisorã€‚\n1 2 3 org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#shouldSkip(Class\u0026lt;?\u0026gt; beanClass, String beanName) =\u0026gt; org.springframework.aop.framework.autoproxy.AspectJAwareAdvisorAutoProxyCreator#findCandidateAdvisors() =\u0026gt; org.springframework.aop.framework.autoproxy.BeanFactoryAdvisorRetrievalHelper#findAdvisorBeans() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 public List\u0026lt;Advisor\u0026gt; findAdvisorBeans() { // è·å– advisorNames String[] advisorNames = this.cachedAdvisorBeanNames; if (advisorNames == null) { // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let the auto-proxy creator apply to them! advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors( this.beanFactory, Advisor.class, true, false); this.cachedAdvisorBeanNames = advisorNames; } if (advisorNames.length == 0) { return new ArrayList\u0026lt;\u0026gt;(); } // ä¸æ–­ä» Factory ä¸­å» getBean() List\u0026lt;Advisor\u0026gt; advisors = new ArrayList\u0026lt;\u0026gt;(); for (String name : advisorNames) { if (isEligibleBean(name)) { if (this.beanFactory.isCurrentlyInCreation(name)) { if (logger.isTraceEnabled()) { logger.trace(\u0026#34;Skipping currently created advisor \u0026#39;\u0026#34; + name + \u0026#34;\u0026#39;\u0026#34;); } } else { try { advisors.add(this.beanFactory.getBean(name, Advisor.class)); } catch (BeanCreationException ex) { // ...... } } } } return advisors; } æœ€ç»ˆåœ¨ BeanFactoryAdvisorRetrievalHelper ä¸­ï¼Œè·å–åˆ°äº†æ‰€æœ‰çš„ advisorã€‚ å¯¹äºæ²¡æœ‰æŒ‡å®š targetSource çš„ Beanï¼ŒAbstractAdvisorAutoProxyCreator ä¸ä¼šå¯¹å…¶è¿›è¡Œä»»ä½•æ“ä½œï¼Œè€Œæ˜¯åªè¿›è¡Œäº† Advisor çš„åˆå§‹åŒ–ã€‚\nåˆ›å»ºä»£ç†ç±» ä» createBean() æ–¹æ³•å¼€å§‹ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ä»£ç†ç±»å…·ä½“æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼š\n1 2 3 4 5 6 org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) =\u0026gt; org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) doCreateBean å°±æ˜¯å®é™…ä¸Šåˆ›å»º Bean çš„æ–¹æ³•ï¼Œå½“ Bean è¢«å®ä¾‹åŒ–å®Œæˆä¹‹åï¼Œä¼šæ‰§è¡Œ Bean çš„åˆå§‹åŒ–ï¼Œå½“å…¶åˆå§‹åŒ–ç»“æŸä¹‹åï¼Œå°±ä¼šæ‰§è¡Œ AbstractAdvisorAutoProxyCreator å®ç°çš„å¦ä¸€ä¸ªé‡è¦æ–¹æ³•ï¼Œä»£ç†ç±»çš„æ„å»ºå°±æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ã€‚ =\u0026gt; `org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) =\u0026gt; `org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName) è¿™ä¸ªæ–¹æ³•ä¼šæ‰§è¡Œæ‰€æœ‰çš„ BeanPostProcessor çš„ postProcessAfterInitialization() æ–¹æ³•ï¼ŒAbstractAdvisorAutoProxyCreator ä¸­çš„è¿™ä¸ªæ–¹æ³•å°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 @Override public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) { if (bean != null) { Object cacheKey = getCacheKey(bean.getClass(), beanName); if (this.earlyProxyReferences.remove(cacheKey) != bean) { return wrapIfNecessary(bean, beanName, cacheKey); } } return bean; } ","date":"2024-11-15T00:00:00Z","image":"http://localhost:60831/p/spring-%E4%BB%A3%E7%90%86%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/image_hu6850457685914377867.png","permalink":"http://localhost:60831/p/spring-%E4%BB%A3%E7%90%86%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/","title":"Spring ä»£ç†ç±»åˆ›å»ºæµç¨‹æ¢³ç†"},{"content":"å‰è¨€ AOPï¼šæ„ä¸ºé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œé€šè¿‡é¢„ç¼–è¯‘çš„æ–¹å¼å’Œè¿è¡ŒæœŸé—´åŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½åŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤ã€‚\næ—¢ç„¶è¦å®ç° AOP å°±ä¸€å®šç¦»ä¸å¼€ä»£ç†ï¼ŒSpring ä¸­ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼šCgLib åŠ¨æ€ä»£ç†å’Œ AOP åŠ¨æ€ä»£ç†ï¼Œè¿˜é€šè¿‡å¼•å…¥ AspectJ æ¥ç®€åŒ–åˆ‡é¢ç¼–ç¨‹ã€‚\nAOP æ‰§è¡Œè¿‡ç¨‹å¯ä»¥ç®€å•ç†è§£ä¸ºå¯¹ åˆ‡ç‚¹(JointPoint) æ‰§è¡Œ é€šçŸ¥(Advice) ä¸­å®šä¹‰çš„é€»è¾‘ï¼Œè¿™å°±å¼•å‡ºä¸¤ä¸ªæ ¸å¿ƒçš„é—®é¢˜éœ€è¦è§£å†³ï¼š\né€šçŸ¥åœ¨ä½•å¤„æ‰§è¡Œï¼Ÿ å¦‚ä½•åˆ¤æ–­å½“å‰æ‰§è¡Œçš„æ–¹æ³•æ˜¯å¦ç¬¦åˆåˆ‡ç‚¹é€»è¾‘ï¼Ÿ åŠ¨æ€ä»£ç†å¯ä»¥è®©æˆ‘ä»¬è‡ªç”±çš„åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥è‡ªå·±çš„é€»è¾‘ï¼Œè¿™å°±è§£å†³äº†é€šçŸ¥åœ¨ä½•å¤„æ‰§è¡Œçš„é—®é¢˜ï¼›\nä½†æ˜¯åŠ¨æ€ä»£ç†ï¼ˆæ— è®ºæ˜¯ JDKProxy çš„ invoke() è¿˜æ˜¯ CgLib çš„ interctpt()ï¼‰éƒ½æ˜¯åœ¨è¢«ä»£ç†çš„ç±»ä¸­çš„ä»»ä½•æ–¹æ³•æ‰§è¡Œå‰æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦éœ€è¦æ‰§è¡Œåˆ‡ç‚¹é€»è¾‘éœ€è¦æˆ‘ä»¬æ¥å®ç°ã€‚\nå›¾ä¾‹\nä¸Šé¢å±•ç¤ºçš„æ˜¯ä¸€ä¸ªä»£ç†ç±»å¤„ç† AOP çš„é€»è¾‘ï¼Œå…¶ä¸­ MethodInterceptor æ˜¯æ–¹æ³•æ‰§è¡Œå‰çš„ä¸€ä¸ªæ‹¦æˆªå™¨ï¼›MethodMatcher æ˜¯ä¸€ä¸ªæ–¹æ³•åŒ¹é…å™¨ï¼Œé€šè¿‡å®ƒæ¥åˆ¤æ–­æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„æ–¹æ³•ä¹‹å‰æ˜¯å¦éœ€è¦å¤„ç†ä»£ç†é€»è¾‘ï¼› å¦‚æœè¢«ä»£ç†çš„æ–¹æ³•ç¬¦åˆåˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œåˆ™æŒ‰ç…§é¡ºåºæ‰§è¡Œå®šä¹‰çš„ä»£ç†é€»è¾‘ï¼Œè¿™æ ·ä¸€ä¸ªç®€å•çš„ AOP é€»è¾‘å°±æ‰“é€šäº†ã€‚\næ¡ˆä¾‹ æ¡ˆä¾‹å‡†å¤‡ 1 2 3 4 5 6 7 8 9 10 11 public class UserService implements IUserService { public void queryUserName(String uId) { System.out.println(\u0026#34;æŸ¥è¯¢ç”¨æˆ·åç§°ä¸ºï¼šryan\u0026#34;); } public void queryUserId(String name) { System.out.println(\u0026#34;æŸ¥è¯¢ç”¨æˆ·IDä¸ºï¼š10001\u0026#34;); } } è¢«ä»£ç†çš„ UserService ç±»ã€‚\nå®šä¹‰æ–¹æ³•åŒ¹é…å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 class MethodMatcherImpl implements MethodMatcher { private final PointcutExpression pointcutExpression; MethodMatcherImpl(String expression) { PointcutParser parser = PointcutParser.getPointcutParserSupportingAllPrimitivesAndUsingContextClassloaderForResolution(); pointcutExpression = parser.parsePointcutExpression(expression); } @Override public boolean matches(Method method, Class\u0026lt;?\u0026gt; aClass) { return pointcutExpression.matchesMethodExecution(method).alwaysMatches(); } @Override public boolean matches(Method method, Class\u0026lt;?\u0026gt; aClass, Object[] objects) { return false; } @Override public boolean isRuntime() { return false; } } è¿™æ˜¯ä¸€ä¸ªæ–¹æ³•åŒ¹é…ç±»ï¼Œç”¨äºæ£€æµ‹è¾“å…¥çš„æ–¹æ³•æ˜¯å¦ç¬¦åˆåˆ‡ç‚¹è¡¨è¾¾å¼ å®šä¹‰æ–¹æ³•æ‹¦æˆªå™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 class CgLibInterceptor implements MethodInterceptor { private final Object target; private final MethodMatcher methodMatcher; CgLibInterceptor(Object target, String expression) { this.methodMatcher = new MethodMatcherImpl(expression); this.target = target; } @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable { if (methodMatcher.matches(method, target.getClass())) { System.out.println(\u0026#34;cglibä»£ç†ï¼šæ‰§è¡Œåˆ‡é¢é€»è¾‘\u0026#34;); return methodProxy.invoke(target, objects); } return methodProxy.invoke(target, objects); } } æä¾›ç»™ CgLib çš„ CallBack ç±»ï¼Œæ ¹æ®æ–¹æ³•æ˜¯å¦åŒ¹é…åˆ‡ç‚¹è¡¨è¾¾å¼æ¥å†³å®šæ˜¯å¦æ‰§è¡Œåˆ‡é¢é€»è¾‘ã€‚ åˆ›å»ºä»£ç†ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class ProxyTest { final static UserService target = new UserService(); public static void main(String[] args) throws IOException, InterruptedException { Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(UserService.class); enhancer.setCallback(new CgLibInterceptor(target, \u0026#34;execution(* com.ryan.aop_test.service.impl.UserService.queryUserName(..))\u0026#34;)); UserService proxyService = (UserService) enhancer.create(); proxyService.queryUserName(\u0026#34;10001\u0026#34;); System.out.println(\u0026#34;======\u0026#34;); proxyService.queryUserId(\u0026#34;ryan\u0026#34;); } } æµ‹è¯•ç±»ï¼Œè¿™é‡Œä½¿ç”¨åˆ‡ç‚¹è¡¨è¾¾å¼åŒ¹é… UserService ç±»ä¸­çš„ queryUserName æ–¹æ³• è¾“å‡ºæ¡ˆä¾‹ä¸­ï¼Œä¹Ÿåªæœ‰è¿™ä¸ªæ–¹æ³•ä¼šè¢«ä»£ç† è¾“å‡ºç»“æœ\n1 2 3 4 cglibä»£ç† æŸ¥è¯¢ç”¨æˆ·åç§°ä¸ºï¼šryan ====== æŸ¥è¯¢ç”¨æˆ·IDä¸ºï¼š10001 ","date":"2024-11-12T00:00:00Z","image":"http://localhost:60831/p/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-aop-%E5%88%87%E9%9D%A2/pawel-czerwinski-8uZPynIu-rQ-unsplash_hu6307248181568134095.jpg","permalink":"http://localhost:60831/p/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-aop-%E5%88%87%E9%9D%A2/","title":"å®ç°ä¸€ä¸ªç®€å•çš„ AOP åˆ‡é¢"},{"content":"ä»€ä¹ˆæ˜¯ AOPï¼Ÿ AOPï¼ˆAspect Oriented Programmingï¼‰ï¼Œæ„ä¸ºé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œé€šè¿‡é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤çš„ä¸€ç§æŠ€æœ¯ã€‚\nAOPæ˜¯OOPçš„å»¶ç»­ï¼Œæ˜¯è½¯ä»¶å¼€å‘ä¸­çš„ä¸€ä¸ªçƒ­ç‚¹ï¼Œä¹Ÿæ˜¯ Spring æ¡†æ¶ä¸­çš„ä¸€ä¸ªé‡è¦å†…å®¹ï¼Œæ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„ä¸€ç§è¡ç”ŸèŒƒå‹ã€‚\nåˆ©ç”¨AOPå¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚\nä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨æ¯æ¬¡è°ƒç”¨ä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•ä¹‹å‰è¾“å‡ºä¸€ä¸ªæ—¥å¿—,é‚£å¦‚æœæˆ‘ä»¬è¦åœ¨è¿™äº›æ–¹æ³•ä¹‹å‰åŠ ä¸€ä¸ªé‰´æƒå‘¢ï¼ŸåŒæ ·ï¼ŒæŒ‰ç…§å‰é¢çš„æ–¹å¼ï¼Œæ— éå°±æ˜¯å¤š copy ä¸€æ¬¡å˜›\nå°±è¿™æ ·ï¼Œé€šè¿‡å¤šé‡ copy çš„æ–¹å¼ï¼Œæœ€ç»ˆå®Œæˆäº†è¿™ä¸ªä¸šåŠ¡ï¼Œè€Œè¿™ä¹Ÿå°±ä»£è¡¨ç€ï¼Œæ¯æ¬¡æ‰©å±•æ–°çš„æ–¹æ³•ï¼Œä½ éƒ½è¦å»è¿›è¡Œ n æ¬¡å¤åˆ¶ç²˜è´´ï¼›æ¯æ¬¡è¦æ›´æ”¹é‰´æƒæˆ–è€…æ—¥å¿—çš„é€»è¾‘ï¼Œä½ éƒ½è¦å»è¿›è¡Œ n æ¬¡å¤åˆ¶ç²˜è´´ï¼›æ¯æ¬¡ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\nå¬èµ·æ¥éƒ½è®©äººéå¸¸å¤´å¤§ï¼Œä½†å¦‚æœæˆ‘ä»¬å°†é€»è¾‘æ”¹æˆè¿™æ ·å‘¢ï¼Ÿ\nç°åœ¨æ¥çœ‹çœ‹ AOP èƒ½å®ç°æ€æ ·çš„æ•ˆæœï¼š\nè¿™æ ·ï¼Œæˆ‘ä»¬è™½ç„¶æ¯æ¬¡éƒ½ä¸ç”¨å»å¤åˆ¶ä»£ç äº†ï¼Œä½†è¿˜æ˜¯éœ€è¦åœ¨æˆ‘ä»¬éœ€è¦çš„ä½ç½®å»è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œè€Œè°ƒç”¨è¿™ä¸ªä»£ç çš„ä½ç½®å…¶å®å°±æ˜¯Â åˆ‡é¢ã€‚æˆ‘ä»¬ç”¨å…·ä½“çš„ä»£ç æ¥çœ‹ä¸€ä¸‹ï¼Œä¸‹é¢å®ç°äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ BeforeAdviceï¼Œç„¶ååœ¨æ¯ä¸ªæ–¹æ³•ä¹‹å‰å»è°ƒç”¨å®ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public interface BeforeAdvice { void before(); } public class LoggingBeforeAdvice implements BeforeAdvice { @Override public void before() { System.out.println(\u0026#34;æ–¹æ³•è°ƒç”¨ä¹‹å‰çš„æ—¥å¿—\u0026#34;); } } public class MyService { private BeforeAdvice beforeAdvice = new LoggingBeforeAdvice(); public void myMethodA() { beforeAdvice.before(); // ä¸šåŠ¡é€»è¾‘ System.out.println(\u0026#34;æ‰§è¡Œ myMethod1A\u0026#34;); } public void myMethodB() { beforeAdvice.before(); // ä¸šåŠ¡é€»è¾‘ System.out.println(\u0026#34;æ‰§è¡Œ myMethodB\u0026#34;); } } AOP æ ¸å¿ƒæ¦‚å¿µ è¿æ¥ç‚¹ï¼ˆJoin Pointï¼‰ï¼šè¿æ¥ç‚¹æ˜¯ç¨‹åºæ‰§è¡Œä¸­çš„ä¸€ä¸ªç‚¹ï¼Œè¿™ä¸ªç‚¹å¯ä»¥æ˜¯æ–¹æ³•è°ƒç”¨ã€æ–¹æ³•æ‰§è¡Œã€å¼‚å¸¸æŠ›å‡ºç­‰ã€‚åœ¨ Spring AOP ä¸­ï¼Œè¿æ¥ç‚¹ä¸»è¦æ˜¯æŒ‡æ–¹æ³•çš„è°ƒç”¨æˆ–æ‰§è¡Œã€‚è¿æ¥ç‚¹æ˜¯é€šçŸ¥çš„å®é™…åº”ç”¨ç‚¹ã€‚\nåˆ‡ç‚¹ï¼ˆPointCutï¼‰ï¼šç”±äºè¿æ¥ç‚¹å¯èƒ½å¾ˆå¤šï¼ˆæ¯”å¦‚ä¸€ä¸ªç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼‰ï¼Œæƒ³è¦æŠŠæ‰€æœ‰è¿æ¥ç‚¹ç½—åˆ—å‡ºç°æ˜¾ç„¶æœ‰äº›å›°éš¾ï¼›åˆ‡ç‚¹æ˜¯ä¸€ä¸ªå®šä¹‰ï¼Œå†³å®šäº† åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨åˆ‡é¢é€»è¾‘ã€‚ åˆ‡ç‚¹é€šè¿‡åˆ‡ç‚¹è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ï¼šexecution(* com.example.service..(..))ï¼‰æ¥æŒ‡å®šåŒ¹é…çš„æ–¹æ³•å’Œç±»ã€‚åˆ‡ç‚¹è¡¨è¾¾å¼ç”¨äºç­›é€‰è¿æ¥ç‚¹ï¼Œä½¿å¾—é€šçŸ¥åªåœ¨ç‰¹å®šçš„è¿æ¥ç‚¹ä¸Šæ‰§è¡Œã€‚\né€šçŸ¥ï¼ˆAdviceï¼‰ï¼šé€šçŸ¥æ˜¯åœ¨åˆ‡ç‚¹å¤„æ‰§è¡Œçš„ä»£ç ã€‚é€šçŸ¥å®šä¹‰äº†å…·ä½“çš„æ¨ªåˆ‡é€»è¾‘ï¼Œå†³å®šäº†åœ¨æ–¹æ³•æ‰§è¡Œçš„ä»€ä¹ˆé˜¶æ®µï¼ˆä¹‹å‰ã€ä¹‹åã€ç¯ç»•ç­‰ï¼‰æ’å…¥æ¨ªåˆ‡é€»è¾‘ã€‚é€šçŸ¥æœ‰äº”ç§ç±»å‹ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€éƒ¨åˆ†è¿›è¡Œè¯¦ç»†çš„äº†è§£ï¼›é€šçŸ¥å°±æ˜¯åœ¨ ä½•æ—¶ æ‰§è¡Œ æ€æ · çš„é€»è¾‘ã€‚\nåˆ‡é¢ï¼ˆAspectï¼‰ï¼šåˆ‡é¢æ˜¯ AOP çš„æ ¸å¿ƒæ¨¡å—ï¼Œå®ƒå°è£…äº†è·¨è¶Šå¤šä¸ªç±»çš„å…³æ³¨ç‚¹ï¼Œä¾‹å¦‚æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†æˆ–å®‰å…¨æ§åˆ¶ã€‚åˆ‡é¢é€šè¿‡é€šçŸ¥ï¼ˆAdviceï¼‰å’Œåˆ‡ç‚¹ï¼ˆPointcutï¼‰æ¥å®šä¹‰åœ¨ä½•æ—¶ã€ä½•åœ°åº”ç”¨è¿™äº›å…³æ³¨ç‚¹ï¼›å¯ä»¥å°†åˆ‡é¢çœ‹ä½œæ˜¯åˆ‡ç‚¹ï¼ˆPointcutï¼‰å’Œé€šçŸ¥ï¼ˆAdviceï¼‰çš„ç»„åˆã€‚ åˆ‡é¢å®šä¹‰äº†åœ¨ä½•å¤„ï¼ˆåˆ‡ç‚¹ï¼‰ä»¥åŠä½•æ—¶ï¼ˆé€šçŸ¥ï¼‰åº”ç”¨æ¨ªåˆ‡é€»è¾‘ã€‚\näº”ç§é€šçŸ¥ç±»å‹ å‰ç½®é€šçŸ¥ï¼ˆBefore Adviceï¼‰ åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„é€šçŸ¥ã€‚å¯ä»¥ç”¨æ¥æ‰§è¡Œæ—¥å¿—è®°å½•ã€å®‰å…¨æ£€æŸ¥ç­‰ã€‚\n1 2 3 4 5 6 7 8 @Aspect @Component public class LoggingAspect { @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) public void beforeAdvice() { System.out.println(\u0026#34;å‰ç½®é€šçŸ¥ï¼šæ–¹æ³•è°ƒç”¨ä¹‹å‰æ‰§è¡Œ\u0026#34;); } } åç½®é€šçŸ¥ï¼ˆAfter Adviceï¼‰ åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œçš„é€šçŸ¥ï¼Œæ— è®ºæ–¹æ³•æ˜¯æˆåŠŸè¿”å›è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚å¸¸ç”¨äºæ¸…ç†èµ„æºç­‰ã€‚\n1 2 3 4 5 6 7 8 @Aspect @Component public class LoggingAspect { @After(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) public void afterAdvice() { System.out.println(\u0026#34;åç½®é€šçŸ¥ï¼šæ–¹æ³•è°ƒç”¨ä¹‹åæ‰§è¡Œ\u0026#34;); } } è¿”å›åé€šçŸ¥ï¼ˆAfter Returning Adviceï¼‰ åœ¨ç›®æ ‡æ–¹æ³•æˆåŠŸè¿”å›ç»“æœä¹‹åæ‰§è¡Œçš„é€šçŸ¥ã€‚å¯ä»¥ç”¨æ¥è®°å½•è¿”å›å€¼æˆ–å¯¹è¿”å›å€¼è¿›è¡Œå¤„ç†ã€‚\n1 2 3 4 5 6 7 8 @Aspect @Component public class LoggingAspect { @AfterReturning(pointcut = \u0026#34;execution(* com.example.service.*.*(..))\u0026#34;, returning = \u0026#34;result\u0026#34;) public void afterReturningAdvice(Object result) { System.out.println(\u0026#34;è¿”å›åé€šçŸ¥ï¼šæ–¹æ³•è¿”å›å€¼ä¸º \u0026#34; + result); } } æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼ˆAfter Throwing Adviceï¼‰ åœ¨ç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åæ‰§è¡Œçš„é€šçŸ¥ã€‚å¯ä»¥ç”¨æ¥è®°å½•å¼‚å¸¸ä¿¡æ¯æˆ–æ‰§è¡Œå¼‚å¸¸å¤„ç†é€»è¾‘ã€‚\n1 2 3 4 5 6 7 8 @Aspect @Component public class LoggingAspect { @AfterThrowing(pointcut = \u0026#34;execution(* com.example.service.*.*(..))\u0026#34;, throwing = \u0026#34;exception\u0026#34;) public void afterThrowingAdvice(Exception exception) { System.out.println(\u0026#34;æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼šå¼‚å¸¸ä¸º \u0026#34; + exception.getMessage()); } } ç¯ç»•é€šçŸ¥ï¼ˆAround Adviceï¼‰ ç¯ç»•é€šçŸ¥åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œçš„å‰åéƒ½æ‰§è¡Œï¼Œå¯ä»¥å®Œå…¨æ§åˆ¶ç›®æ ‡æ–¹æ³•çš„æ‰§è¡Œï¼ŒåŒ…æ‹¬å†³å®šæ˜¯å¦æ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼Œä»¥åŠåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰åæ·»åŠ è‡ªå®šä¹‰é€»è¾‘ã€‚ç¯ç»•é€šçŸ¥æœ€ä¸ºå¼ºå¤§å’Œçµæ´»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 @Aspect @Component public class LoggingAspect { @Around(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) public Object aroundAdvice(ProceedingJoinPoint joinPoint) throws Throwable { System.out.println(\u0026#34;ç¯ç»•é€šçŸ¥ï¼šæ–¹æ³•è°ƒç”¨ä¹‹å‰\u0026#34;); Object result = joinPoint.proceed(); // æ‰§è¡Œç›®æ ‡æ–¹æ³• System.out.println(\u0026#34;ç¯ç»•é€šçŸ¥ï¼šæ–¹æ³•è°ƒç”¨ä¹‹å\u0026#34;); return result; } } è¿™äº”ç§é€šçŸ¥ç±»å‹çš„æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š å‰ç½®é€šçŸ¥ï¼ˆBefore Adviceï¼‰ ç¯ç»•é€šçŸ¥ï¼ˆAround Adviceï¼‰çš„å‰åŠéƒ¨åˆ† ç›®æ ‡æ–¹æ³•æ‰§è¡Œ ç¯ç»•é€šçŸ¥ï¼ˆAround Adviceï¼‰çš„ååŠéƒ¨åˆ† è¿”å›åé€šçŸ¥ï¼ˆAfter Returning Adviceï¼‰ï¼ˆå¦‚æœç›®æ ‡æ–¹æ³•æˆåŠŸè¿”å›ï¼‰ æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼ˆAfter Throwing Adviceï¼‰ï¼ˆå¦‚æœç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼‰ åç½®é€šçŸ¥ï¼ˆAfter Adviceï¼‰\n","date":"2020-09-09T00:00:00Z","image":"http://localhost:60831/p/aop-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/the-creative-exchange-d2zvqp3fpro-unsplash_hu5876398126655421130.jpg","permalink":"http://localhost:60831/p/aop-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/","title":"AOP æ ¸å¿ƒæ¦‚å¿µ"},{"content":"Lorem est tota propiore conpellat pectoribus de pectora summo.\nRedit teque digerit hominumque toris verebor lumina non cervice subde tollit usus habet Arctonque, furores quas nec ferunt. Quoque montibus nunc caluere tempus inhospita parcite confusaque translucet patri vestro qui optatis lumine cognoscere flos nubis! Fronde ipsamque patulos Dryopen deorum.\nExierant elisi ambit vivere dedere Duce pollice Eris modo Spargitque ferrea quos palude Rursus nulli murmur; hastile inridet ut ab gravi sententia! Nomine potitus silentia flumen, sustinet placuit petis in dilapsa erat sunt. Atria tractus malis.\nComas hunc haec pietate fetum procerum dixit Post torum vates letum Tiresia Flumen querellas Arcanaque montibus omnes Quidem et Vagus elidunt The Van de Graaf Canon\nMane refeci capiebant unda mulcebat Victa caducifer, malo vulnere contra dicere aurato, ludit regale, voca! Retorsit colit est profanae esse virescere furit nec; iaculi matertera et visa est, viribus. Divesque creatis, tecta novat collumque vulnus est, parvas. Faces illo pepulere tempus adest. Tendit flamma, ab opes virum sustinet, sidus sequendo urbis.\nIubar proles corpore raptos vero auctor imperium; sed et huic: manus caeli Lelegas tu lux. Verbis obstitit intus oblectamina fixis linguisque ausus sperare Echionides cornuaque tenent clausit possit. Omnia putatur. Praeteritae refert ausus; ferebant e primus lora nutat, vici quae mea ipse. Et iter nil spectatae vulnus haerentia iuste et exercebat, sui et.\nEurytus Hector, materna ipsumque ut Politen, nec, nate, ignari, vernum cohaesit sequitur. Vel mitis temploque vocatus, inque alis, oculos nomen non silvis corpore coniunx ne displicet illa. Crescunt non unus, vidit visa quantum inmiti flumina mortis facto sic: undique a alios vincula sunt iactata abdita! Suspenderat ego fuit tendit: luna, ante urbem Propoetides parte.\n","date":"2019-03-09T00:00:00Z","image":"http://localhost:60831/p/placeholder-text/matt-le-SJSpo9hQf7s-unsplash_hu10664154974910995856.jpg","permalink":"http://localhost:60831/p/placeholder-text/","title":"Placeholder Text"},{"content":"Mathematical notation in a Hugo project can be enabled by using third party JavaScript libraries.\nIn this example we will be using KaTeX\nCreate a partial under /layouts/partials/math.html Within this partial reference the Auto-render Extension or host these scripts locally. Include the partial in your templates like so: 1 2 3 {{ if or .Params.math .Site.Params.math }} {{ partial \u0026#34;math.html\u0026#34; . }} {{ end }} To enable KaTeX globally set the parameter math to true in a project\u0026rsquo;s configuration To enable KaTeX on a per page basis include the parameter math: true in content files Note: Use the online reference of Supported TeX Functions\nExamples Inline math: $\\varphi = \\dfrac{1+\\sqrt5}{2}= 1.6180339887â€¦$\nBlock math: $$ \\varphi = 1+\\frac{1} {1+\\frac{1} {1+\\frac{1} {1+\\cdots} } } $$","date":"2019-03-08T00:00:00Z","permalink":"http://localhost:60831/p/math-typesetting/","title":"Math Typesetting"}]