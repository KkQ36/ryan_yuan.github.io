[{"content":"Springä»£ç†ç±»åˆ›å»ºæµç¨‹æ¢³ç†\næ²¿ç€ä¸ŠèŠ‚çš„æµç¨‹ï¼Œè¯¦ç»†çš„æ¥çœ‹çœ‹ wrapIfNecessary() æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) { if (StringUtils.hasLength(beanName) \u0026amp;\u0026amp; this.targetSourcedBeans.contains(beanName)) { return bean; } if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) { return bean; } if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) { this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; } // å¦‚æœè¯¥ç±»çš„ Advisor ä¸ä¸ºç©ºï¼Œåˆ›å»ºä»£ç†ç±» Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); if (specificInterceptors != DO_NOT_PROXY) { this.advisedBeans.put(cacheKey, Boolean.TRUE); Object proxy = createProxy( bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean)); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; } this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; } ä¸ç”Ÿæˆä»£ç†ç±»çš„æƒ…å†µ 1 2 3 4 5 6 7 8 9 10 if (StringUtils.hasLength(beanName) \u0026amp;\u0026amp; this.targetSourcedBeans.contains(beanName)) { return bean; } if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) { return bean; } if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) { this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; } ä»¥ä¸‹çš„å››ç§æƒ…å†µå°†ä¸ä¼šç”Ÿæˆä»£ç†ç±»ï¼š\nBeanName ä¸ä¸ºç©ºä¸”åœ¨ targetSourcedBeans é›†åˆä¸­ï¼Œç›´æ¥è¿”å›åŸå§‹ beanã€‚ AdvisedBeans ç¼“å­˜ä¸­å­˜åœ¨ cacheKey ä¸”å€¼ä¸º falseï¼Œç›´æ¥è¿”å›åŸå§‹ beanã€‚ Bean å±äºåŸºç¡€è®¾æ–½ç±»æˆ–æ»¡è¶³è·³è¿‡æ¡ä»¶ï¼Œå°† cacheKey æ ‡è®°ä¸º false å¹¶è¿”å›åŸå§‹ beanã€‚ æ²¡æœ‰ä¸ Bean åŒ¹é…çš„ Advisor è·å–é€‚é…ç±»çš„ Advisors 1 Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); org.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean(Class\u0026lt;?\u0026gt; beanClass, String beanName, @Nullable TargetSource targetSource)\n1 2 3 4 5 6 7 8 9 @Override @Nullable protected Object[] getAdvicesAndAdvisorsForBean(Class\u0026lt;?\u0026gt; beanClass, String beanName, @Nullable TargetSource targetSource) { List\u0026lt;Advisor\u0026gt; advisors = findEligibleAdvisors(beanClass, beanName); if (advisors.isEmpty()) { return DO_NOT_PROXY; } return advisors.toArray(); } org.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreator#findEligibleAdvisors(Class\u0026lt;?\u0026gt; beanClass, String beanName)\n1 2 3 4 5 6 7 8 9 protected List\u0026lt;Advisor\u0026gt; findEligibleAdvisors(Class\u0026lt;?\u0026gt; beanClass, String beanName) { List\u0026lt;Advisor\u0026gt; candidateAdvisors = findCandidateAdvisors(); List\u0026lt;Advisor\u0026gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName); extendAdvisors(eligibleAdvisors); if (!eligibleAdvisors.isEmpty()) { eligibleAdvisors = sortAdvisors(eligibleAdvisors); } return eligibleAdvisors; } é¦–å…ˆè°ƒç”¨ findCandidateAdvisors æ‹¿åˆ°æ‰€æœ‰çš„å€™é€‰è€… Advisorï¼Œå†è°ƒç”¨ findAdvisorsThatCanApply é€‰å‡ºé€‚é…è¯¥ Bean çš„ Advisorã€‚\næœ€ç»ˆä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼š org.springframework.aop.support.AopUtils#findAdvisorsThatCanApply(List\u0026lt;Advisor\u0026gt; candidateAdvisors, Class\u0026lt;?\u0026gt; clazz)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public static List\u0026lt;Advisor\u0026gt; findAdvisorsThatCanApply(List\u0026lt;Advisor\u0026gt; candidateAdvisors, Class\u0026lt;?\u0026gt; clazz) { if (candidateAdvisors.isEmpty()) { return candidateAdvisors; } List\u0026lt;Advisor\u0026gt; eligibleAdvisors = new ArrayList\u0026lt;\u0026gt;(); for (Advisor candidate : candidateAdvisors) { if (candidate instanceof IntroductionAdvisor \u0026amp;\u0026amp; canApply(candidate, clazz)) { eligibleAdvisors.add(candidate); } } boolean hasIntroductions = !eligibleAdvisors.isEmpty(); for (Advisor candidate : candidateAdvisors) { if (candidate instanceof IntroductionAdvisor) { // already processed continue; } if (canApply(candidate, clazz, hasIntroductions)) { eligibleAdvisors.add(candidate); } } return eligibleAdvisors; } è¿™ä¸ªæ–¹æ³• findAdvisorsThatCanApply ç”¨äºè¿‡æ»¤å’Œç­›é€‰å‡ºå¯ä»¥åº”ç”¨äºç‰¹å®šç›®æ ‡ç±» clazz çš„å¢å¼ºå™¨ï¼ˆAdvisorï¼‰ï¼Œå³ æ‰¾å‡ºä¸è¯¥ç±»åŒ¹é…çš„ Advisor åˆ—è¡¨ã€‚ é¦–å…ˆéå† candidateAdvisors åˆ—è¡¨ï¼Œç­›é€‰å‡ºæ‰€æœ‰çš„ IntroductionAdvisorã€‚ å¯¹äºæ¯ä¸ª IntroductionAdvisorï¼Œè°ƒç”¨ canApply(candidate, clazz) æ–¹æ³•åˆ¤æ–­å®ƒæ˜¯å¦é€‚ç”¨äºç›®æ ‡ç±» clazzã€‚ å¦‚æœé€‚ç”¨ï¼Œå°±å°†å®ƒæ·»åŠ åˆ° eligibleAdvisors åˆ—è¡¨ä¸­ã€‚ å†æ¬¡éå† candidateAdvisors åˆ—è¡¨ï¼Œæ’é™¤ IntroductionAdvisorï¼Œåªå¤„ç†æ™®é€šçš„ Advisorã€‚ å¯¹äºæ¯ä¸ªæ™®é€šçš„ Advisorï¼Œè°ƒç”¨ canApply(candidate, clazz, hasIntroductions) æ–¹æ³•æ£€æŸ¥å®ƒæ˜¯å¦é€‚ç”¨äºç›®æ ‡ç±» clazzã€‚ å¦‚æœé€‚ç”¨ï¼Œå°†å…¶æ·»åŠ åˆ° eligibleAdvisors åˆ—è¡¨ä¸­ã€‚\nåˆ›å»ºä»£ç†ç±» 1 2 3 4 5 6 7 if (specificInterceptors != DO_NOT_PROXY) { this.advisedBeans.put(cacheKey, Boolean.TRUE); Object proxy = createProxy( bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean)); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; } å¦‚æœ specificInterceptors ä¸ä¸º null å°±ä¼šå»åˆ›å»ºä»£ç†ï¼›\norg.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#createProxy(Class\u0026lt;?\u0026gt; beanClass, @Nullable String beanName, @Nullable Object[] specificInterceptors, TargetSource targetSource)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 protected Object createProxy(Class\u0026lt;?\u0026gt; beanClass, @Nullable String beanName, @Nullable Object[] specificInterceptors, TargetSource targetSource) { if (this.beanFactory instanceof ConfigurableListableBeanFactory) { AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) this.beanFactory, beanName, beanClass); } ProxyFactory proxyFactory = new ProxyFactory(); proxyFactory.copyFrom(this); if (proxyFactory.isProxyTargetClass()) { // Explicit handling of JDK proxy targets and lambdas (for introduction advice scenarios) if (Proxy.isProxyClass(beanClass) || ClassUtils.isLambdaClass(beanClass)) { // Must allow for introductions; can\u0026#39;t just set interfaces to the proxy\u0026#39;s interfaces only. for (Class\u0026lt;?\u0026gt; ifc : beanClass.getInterfaces()) { proxyFactory.addInterface(ifc); } } } else { // No proxyTargetClass flag enforced, let\u0026#39;s apply our default checks... if (shouldProxyTargetClass(beanClass, beanName)) { proxyFactory.setProxyTargetClass(true); } else { evaluateProxyInterfaces(beanClass, proxyFactory); } } Advisor[] advisors = buildAdvisors(beanName, specificInterceptors); proxyFactory.addAdvisors(advisors); proxyFactory.setTargetSource(targetSource); customizeProxyFactory(proxyFactory); proxyFactory.setFrozen(this.freezeProxy); if (advisorsPreFiltered()) { proxyFactory.setPreFiltered(true); } // Use original ClassLoader if bean class not locally loaded in overriding class loader ClassLoader classLoader = getProxyClassLoader(); if (classLoader instanceof SmartClassLoader \u0026amp;\u0026amp; classLoader != beanClass.getClassLoader()) { classLoader = ((SmartClassLoader) classLoader).getOriginalClassLoader(); } return proxyFactory.getProxy(classLoader); } è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸ºï¼šproxyFactory.getProxy(classLoader);ï¼Œå³è°ƒç”¨ proxyFactory çš„åˆ›å»ºä»£ç†æ–¹æ³•ã€‚\nä»£ç†å·¥å‚çš„åˆå§‹åŒ–é…ç½® æ•´ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯å¯¹ä»£ç†å·¥å‚çš„ä¸€ä¸ªæ„å»ºï¼Œåœ¨è°ƒç”¨ proxyFactory.copyFrom(this); ï¼Œä¼šå°† Creator çš„é…ç½®å¤åˆ¶åˆ°ä»£ç†å·¥å‚ä¸­ï¼š org.springframework.aop.framework.ProxyConfig#copyFrom(ProxyConfig other)\n1 2 3 4 5 6 7 8 public void copyFrom(ProxyConfig other) { Assert.notNull(other, \u0026#34;Other ProxyConfig object must not be null\u0026#34;); this.proxyTargetClass = other.proxyTargetClass; this.optimize = other.optimize; this.exposeProxy = other.exposeProxy; this.frozen = other.frozen; this.opaque = other.opaque; } proxyTargetSourceï¼šè®¾ç½®æ˜¯å¦ç›´æ¥ä»£ç†ç›®æ ‡ç±»ï¼Œè€Œä¸æ˜¯ä»…ä»£ç†ç‰¹å®šçš„æ¥å£ã€‚é»˜è®¤å€¼ä¸º \u0026ldquo;false\u0026rdquo;ã€‚\nå°†å…¶è®¾ç½®ä¸º \u0026ldquo;true\u0026rdquo; æ—¶ï¼Œä¼šå¼ºåˆ¶å¯¹ TargetSource æ‰€æš´éœ²çš„ç›®æ ‡ç±»è¿›è¡Œä»£ç†ã€‚ å¦‚æœç›®æ ‡ç±»æ˜¯ä¸€ä¸ªæ¥å£ï¼Œåˆ™ä¼šä¸ºè¯¥æ¥å£åˆ›å»ºä¸€ä¸ª JDK ä»£ç†ã€‚ å¦‚æœç›®æ ‡ç±»æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ï¼Œåˆ™ä¼šä¸ºè¯¥ç±»åˆ›å»ºä¸€ä¸ª CGLIB ä»£ç†ã€‚ optimizeï¼šè®¾ç½®ä»£ç†æ˜¯å¦åº”æ‰§è¡Œâ€œç§¯æä¼˜åŒ–â€ã€‚\nâ€œç§¯æä¼˜åŒ–â€çš„å…·ä½“å«ä¹‰å› ä»£ç†ç±»å‹è€Œå¼‚ï¼Œä½†é€šå¸¸ä¼šæ¶‰åŠæŸç§æƒè¡¡ï¼Œé»˜è®¤å€¼ä¸º \u0026ldquo;false\u0026rdquo;ã€‚ åœ¨ Spring å½“å‰çš„ä»£ç†é€‰é¡¹ä¸­ï¼Œæ­¤æ ‡å¿—å®é™…ä¸Šä¼šå¼ºåˆ¶ä½¿ç”¨ CGLIB ä»£ç†ï¼Œä½†ä¸ä¼šæ‰§è¡Œä»»ä½•ç±»éªŒè¯æ£€æŸ¥ï¼ˆå¦‚å¯¹ final æ–¹æ³•çš„æ£€æŸ¥ç­‰ï¼‰ã€‚ opaqueï¼šè®¾ç½®ç”±æ­¤é…ç½®åˆ›å»ºçš„ä»£ç†æ˜¯å¦åº”è¯¥ç¦æ­¢è¢«å¼ºåˆ¶è½¬æ¢ä¸º {@link Advised} ä»¥æŸ¥è¯¢ä»£ç†çŠ¶æ€ã€‚\né»˜è®¤å€¼ä¸º \u0026ldquo;false\u0026rdquo;ï¼Œè¿™æ„å‘³ç€ä»»ä½• AOP ä»£ç†éƒ½å¯ä»¥è¢«å¼ºåˆ¶è½¬æ¢ä¸º {@link Advised}ã€‚ frozenï¼šå†³å®šä»£ç†çš„é…ç½®æ˜¯å¦å¯ä»¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œé…ç½®æ˜¯å¯å˜çš„ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡å°†ä»£ç†è½¬æ¢ä¸º Advised æ¥å£æ¥ä¿®æ”¹é€šçŸ¥é“¾æˆ–å…¶ä»–é…ç½®ã€‚ å½“å…¶è®¾ç½®ä¸º true çš„æ—¶å€™ï¼š é…ç½®è¢«é”å®šï¼Œä¸èƒ½å†åŠ¨æ€æ›´æ”¹é€šçŸ¥æˆ–åˆ‡é¢é…ç½®ã€‚ å¢å¼ºç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œå› ä¸ºä»£ç†ä¸éœ€è¦æ”¯æŒåŠ¨æ€ä¿®æ”¹ã€‚ æ ¹æ®æ˜¯å¦ä»£ç†ç›®æ ‡ç±»æ‰§è¡Œä¸åŒçš„æ“ä½œ å¯¹åº”æºç çš„è¿™ä¸€éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 if (proxyFactory.isProxyTargetClass()) { // Explicit handling of JDK proxy targets and lambdas (for introduction advice scenarios) if (Proxy.isProxyClass(beanClass) || ClassUtils.isLambdaClass(beanClass)) { // Must allow for introductions; can\u0026#39;t just set interfaces to the proxy\u0026#39;s interfaces only. for (Class\u0026lt;?\u0026gt; ifc : beanClass.getInterfaces()) { proxyFactory.addInterface(ifc); } } } else { // No proxyTargetClass flag enforced, let\u0026#39;s apply our default checks... if (shouldProxyTargetClass(beanClass, beanName)) { proxyFactory.setProxyTargetClass(true); } else { evaluateProxyInterfaces(beanClass, proxyFactory); } } ä¸Šé¢æˆ‘ä»¬æåˆ°ï¼ŒproxyTargetSourceï¼šè®¾ç½®æ˜¯å¦ç›´æ¥ä»£ç†ç›®æ ‡ç±»ï¼Œè€Œä¸æ˜¯ä»…ä»£ç†ç‰¹å®šçš„æ¥å£ã€‚é»˜è®¤å€¼ä¸º \u0026ldquo;false\u0026rdquo;ã€‚ å¦‚æœä¸º true çš„è¯ï¼Œå¯¹ JDK ä»£ç†ç±»å’Œ lambda æ¥å£çš„å®ç°ç±»åšä¸€äº›ç‰¹æ®Šçš„å¤„ç†ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜æ¥å£çš„ç±»å‹ã€‚ å¦‚æœè®¾ç½®ä¸º false çš„è¯ï¼Œæ‰§è¡Œé»˜è®¤çš„æ“ä½œ é¦–å…ˆæ£€æŸ¥ Bean å®šä¹‰ä¸­æ˜¯å¦æ˜ç¡®åˆ¶å®šäº†éœ€è¦ä»£ç†ç±»è€Œä¸æ˜¯æ¥å£ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°† proxyTargetSource è®¾ç½®ä¸º trueã€‚ åä¹‹è°ƒç”¨ evaluateProxyInterfacesï¼Œè¯„ä¼° Bean æ˜¯å¦æœ‰å®ç°çš„æ¥å£ï¼Œæˆ‘ä»¬è¯´çš„å¦‚æœ ä»£ç†ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œä½¿ç”¨ CgLib ä»£ç†ï¼Œåä¹‹ï¼Œä½¿ç”¨ JDK ä»£ç†æ­£æ˜¯è¿™ä¸ªæ–¹æ³•çš„åŸå› ã€‚\nå…¨é™å®šåï¼šorg.springframework.aop.framework.ProxyProcessorSupport#evaluateProxyInterfaces(Class\u0026lt;?\u0026gt; beanClass, ProxyFactory proxyFactory) æ–¹æ³•æ³¨é‡Šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /** * Check the interfaces on the given bean class and apply them to the {@link ProxyFactory}, * if appropriate. * \u0026lt;p\u0026gt;Calls {@link #isConfigurationCallbackInterface} and {@link #isInternalLanguageInterface} * to filter for reasonable proxy interfaces, falling back to a target-class proxy otherwise. * @param beanClass the class of the bean * @param proxyFactory the ProxyFactory for the bean */ /** * æ£€æŸ¥ç»™å®š Bean ç±»ä¸Šçš„æ¥å£ï¼Œå¹¶åœ¨åˆé€‚çš„æƒ…å†µä¸‹å°†è¿™äº›æ¥å£åº”ç”¨åˆ° {@link ProxyFactory}ã€‚ * * \u0026lt;p\u0026gt;ä¼šè°ƒç”¨ {@link #isConfigurationCallbackInterface} å’Œ {@link #isInternalLanguageInterface} * æ–¹æ³•æ¥è¿‡æ»¤å‡ºåˆç†çš„ä»£ç†æ¥å£ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆç†çš„æ¥å£ï¼Œåˆ™ä¼šé€€å›åˆ°åŸºäºç›®æ ‡ç±»ï¼ˆtarget-classï¼‰çš„ä»£ç†ã€‚ * * @param beanClass Bean çš„ç±» * @param proxyFactory ç”¨äºåˆ›å»ºä»£ç†çš„ {@link ProxyFactory} */ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 protected void evaluateProxyInterfaces(Class\u0026lt;?\u0026gt; beanClass, ProxyFactory proxyFactory) { Class\u0026lt;?\u0026gt;[] targetInterfaces = ClassUtils.getAllInterfacesForClass(beanClass, getProxyClassLoader()); boolean hasReasonableProxyInterface = false; for (Class\u0026lt;?\u0026gt; ifc : targetInterfaces) { if (!isConfigurationCallbackInterface(ifc) \u0026amp;\u0026amp; !isInternalLanguageInterface(ifc) \u0026amp;\u0026amp; ifc.getMethods().length \u0026gt; 0) { hasReasonableProxyInterface = true; break; } } if (hasReasonableProxyInterface) { // Must allow for introductions; can\u0026#39;t just set interfaces to the target\u0026#39;s interfaces only. for (Class\u0026lt;?\u0026gt; ifc : targetInterfaces) { proxyFactory.addInterface(ifc); } } else { proxyFactory.setProxyTargetClass(true); } } è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä»ç›®æ ‡ç±»ï¼ˆbeanClassï¼‰ä¸­æå–éœ€è¦ä»£ç†çš„æ¥å£ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°ä»£ç†å·¥å‚ï¼ˆProxyFactoryï¼‰ä¸­ï¼Œè€Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ¥å£ï¼ˆå³æ‰€æœ‰æ¥å£éƒ½è¢«è¿‡æ»¤æ‰ï¼‰ï¼Œåˆ™ä¼šä½¿ç”¨ç›®æ ‡ç±»è¿›è¡Œä»£ç†ï¼ˆå³å¯ç”¨ CGLIB åŠ¨æ€ä»£ç†ï¼‰ã€‚ ä½¿ç”¨ isConfigurationCallbackInterface å’Œ isInternalLanguageInterface æ–¹æ³•å¯¹æ¥å£è¿›è¡Œç­›é€‰ï¼Œç¡®ä¿åªä»£ç†åˆç†çš„æ¥å£ã€‚\nåˆç†çš„æ¥å£é€šå¸¸æ˜¯ç”¨æˆ·å®šä¹‰çš„æ¥å£ï¼Œè€Œé Spring å†…éƒ¨ä½¿ç”¨çš„å›è°ƒæ¥å£æˆ–ä¸è¯­è¨€æœºåˆ¶ç›¸å…³çš„å†…éƒ¨æ¥å£ã€‚ è¿™ä¸¤ä¸ªæ–¹æ³•å°†è¿™äº›æ¥å£æ’é™¤åœ¨å¤–ï¼š 1 2 3 4 5 6 7 8 9 protected boolean isConfigurationCallbackInterface(Class\u0026lt;?\u0026gt; ifc) { return (InitializingBean.class == ifc || DisposableBean.class == ifc || Closeable.class == ifc || AutoCloseable.class == ifc || ObjectUtils.containsElement(ifc.getInterfaces(), Aware.class)); } protected boolean isInternalLanguageInterface(Class\u0026lt;?\u0026gt; ifc) { return (ifc.getName().equals(\u0026#34;groovy.lang.GroovyObject\u0026#34;) || ifc.getName().endsWith(\u0026#34;.cglib.proxy.Factory\u0026#34;) || ifc.getName().endsWith(\u0026#34;.bytebuddy.MockAccess\u0026#34;)); } å¦‚æœç­›é€‰åæ²¡æœ‰é€‚åˆçš„æ¥å£ï¼Œåˆ™ä¼šå›é€€åˆ°åŸºäºç›®æ ‡ç±»çš„ä»£ç†æ–¹å¼ï¼ˆ è§¦å‘ CGLIB åŠ¨æ€ä»£ç† ï¼‰ã€‚\nå¡«å……ä»£ç†å·¥å‚çš„å…¶ä»–å±æ€§ å¯¹åº”æºç çš„è¿™ä¸€éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Advisor[] advisors = buildAdvisors(beanName, specificInterceptors); proxyFactory.addAdvisors(advisors); proxyFactory.setTargetSource(targetSource); customizeProxyFactory(proxyFactory); proxyFactory.setFrozen(this.freezeProxy); if (advisorsPreFiltered()) { proxyFactory.setPreFiltered(true); } // Use original ClassLoader if bean class not locally loaded in overriding class loader ClassLoader classLoader = getProxyClassLoader(); if (classLoader instanceof SmartClassLoader \u0026amp;\u0026amp; classLoader != beanClass.getClassLoader()) { classLoader = ((SmartClassLoader) classLoader).getOriginalClassLoader(); } è·å–å¹¶æ„å»ºä¸€ä¸ª Advisor åˆ—è¡¨ï¼Œè¿™ä¸ª specificInterceptors æ˜¯ä» wrapIfNecessoryä¸­ä¼ é€’ä¸‹æ¥çš„ï¼Œç„¶åå°†è¿™äº› Advisor æ·»åŠ åˆ°ä»£ç†å·¥å‚ã€‚ Spring ä½¿ç”¨ SmartClassLoader æ£€æµ‹ç›®æ ‡ç±»çš„ç±»åŠ è½½å™¨å’Œä»£ç†ç±»çš„ç±»åŠ è½½å™¨æ˜¯å¦ä¸€è‡´ï¼š å¦‚æœä»£ç†ç±»çš„ç±»åŠ è½½å™¨ä¸ç›®æ ‡ç±»ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç±»åŠ è½½é—®é¢˜ï¼Œå› æ­¤ Spring ä¼šå°è¯•è°ƒæ•´ä½¿ç”¨çš„ç±»åŠ è½½å™¨ã€‚\næ­£å¼å¼€å§‹åˆ›å»ºä»£ç†ç±» 1 return proxyFactory.getProxy(classLoader); å…¶æœ€ç»ˆä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼š\nå…¨é™å®šåï¼šorg.springframework.aop.framework.DefaultAopProxyFactory#createAopProxy(AdvisedSupport config) æ¥å£å®šä¹‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /** * Create an {@link AopProxy} for the given AOP configuration. * @param config the AOP configuration in the form of an * AdvisedSupport object * @return the corresponding AOP proxy * @throws AopConfigException if the configuration is invalid */ /** * ä¸ºç»™å®šçš„ AOP é…ç½®åˆ›å»ºä¸€ä¸ª {@link AopProxy} å®ä¾‹ã€‚ * * @param config ä»¥ {@link AdvisedSupport} å¯¹è±¡å½¢å¼è¡¨ç¤ºçš„ AOP é…ç½®ä¿¡æ¯ * @return å¯¹åº”çš„ AOP ä»£ç† * @throws AopConfigException å¦‚æœé…ç½®æ— æ•ˆï¼Œåˆ™æŠ›å‡ºæ­¤å¼‚å¸¸ / 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException { if (!NativeDetector.inNativeImage() \u0026amp;\u0026amp; (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config))) { Class\u0026lt;?\u0026gt; targetClass = config.getTargetClass(); if (targetClass == null) { throw new AopConfigException(\u0026#34;TargetSource cannot determine target class: \u0026#34; + \u0026#34;Either an interface or a target is required for proxy creation.\u0026#34;); } if (targetClass.isInterface() || Proxy.isProxyClass(targetClass) || ClassUtils.isLambdaClass(targetClass)) { return new JdkDynamicAopProxy(config); } return new ObjenesisCglibAopProxy(config); } else { return new JdkDynamicAopProxy(config); } } ä¼ å…¥çš„å‚æ•° AdvisedSupport å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ„å»ºçš„ä»£ç†å·¥å‚ï¼Œå…¶å®ç°äº† AdvisedSupport æ¥å£ã€‚ æˆ‘ä»¬å†æ¥æ¢³ç†ä¸€ä¸‹è¿™ä¸ªé…ç½®ä¸­å¯¹ä¸€äº›å€¼ï¼š\nisOptimizeï¼šé»˜è®¤ falseï¼Œä¸è¿›è¡Œæ™ºèƒ½ä»£ç†ä¼˜åŒ– isProxyTargetClassï¼šç±»æˆ–è€…Creator æŒ‡å®šéœ€è¦ä»£ç†çš„æ˜¯ç›®æ ‡ç±» æˆ– ç±»æ²¡æœ‰å®ç°ä»»ä½•å¯ç”¨æ¥å£ æ—¶ä¸º trueï¼Œå…¶ä»–æ—¶å€™ä¸º false åˆ›å»º CgLib ä»£ç†ç±» å¯¹åº”æºç çš„è¿™ä¸€éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 if (!NativeDetector.inNativeImage() \u0026amp;\u0026amp; (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config))) { Class\u0026lt;?\u0026gt; targetClass = config.getTargetClass(); if (targetClass == null) { throw new AopConfigException(\u0026#34;TargetSource cannot determine target class: \u0026#34; + \u0026#34;Either an interface or a target is required for proxy creation.\u0026#34;); } if (targetClass.isInterface() || Proxy.isProxyClass(targetClass) || ClassUtils.isLambdaClass(targetClass)) { return new JdkDynamicAopProxy(config); } return new ObjenesisCglibAopProxy(config); } !NativeDetector.inNativeImage() ç”¨äºæ£€æµ‹å½“å‰ç¯å¢ƒèƒ½å¦ä½¿ç”¨ CgLib ä»£ç†ï¼Œå¦‚æœå…è®¸çš„è¯ï¼Œä¸‹é¢çš„æ¡ä»¶ç¬¦åˆä»»æ„ä¸€æ¡éƒ½ä¼šå‡ºå‘ CgLib ä»£ç†ï¼š\nisOptimize æ™ºèƒ½ä»£ç†ä¼˜åŒ– isProxyTargetClass éœ€è¦ä»£ç†ç›®æ ‡ç±» hasNoUserSuppliedProxyInterfacesï¼Œæ£€æµ‹æ¥å£ï¼Œå¦‚æœå‘ç°ç”¨æˆ·æ²¡æœ‰æä¾›ä»»ä½•è‡ªå®šä¹‰æ¥å£ï¼ŒSpring å¯èƒ½ä¼šé€‰æ‹©ä½¿ç”¨ CGLIB ä»£ç†ã€‚ è¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„æƒ…å†µï¼Œåˆ›å»ºçš„æ˜¯ JDK ä»£ç†ç±»ï¼Œè¿™ä¸ªæ”¾åˆ°ä¸‹é¢å»è¯´ã€‚ åˆ›å»º JDK ä»£ç†ç±» å½“ä¸‹é¢çš„æ¡ä»¶ä¸ç¬¦åˆ\n1 !NativeDetector.inNativeImage() \u0026amp;\u0026amp; (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) æˆ–è€…ä»£ç†çš„ç±»æ˜¯ä¸€ä¸ªæ¥å£ã€ä»£ç†çš„ç±»å·²ç»æ˜¯ä¸€ä¸ª JDK ä»£ç†ç±»ã€ä»£ç†çš„ç±»æ˜¯ä¸€ä¸ª lambda è¡¨è¾¾å¼çš„å®ç°ç±»\n1 targetClass.isInterface() || Proxy.isProxyClass(targetClass) || ClassUtils.isLambdaClass(targetClass) çš„æ—¶å€™ï¼Œä¼šåˆ›å»º JDK ä»£ç†ç±»ã€‚\n","date":"2024-11-17T00:00:00Z","image":"http://localhost:64097/p/spring-aop-%E4%BB%A3%E7%90%86%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95%E8%A7%A3%E6%9E%90/image_hu15123054864233634991.png","permalink":"http://localhost:64097/p/spring-aop-%E4%BB%A3%E7%90%86%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95%E8%A7%A3%E6%9E%90/","title":"Spring AOP ä»£ç†ç±»åˆ›å»ºæ–¹æ³•è§£æ"},{"content":"ä¸€å¥è¯æ¥è¯´ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸ºäº† è§£å†³é›†åˆä¸­æ˜¯å¦å­˜åœ¨æŸä¸€å…ƒç´  è¿™ä¸€é—®é¢˜ã€‚ è¿™ç§éœ€æ±‚éå¸¸å¸¸è§ï¼Œæ¯”å¦‚ç°æœ‰ 500 ä¸‡ä¸ªç”µè¯å·ç ï¼Œç»™ä½  1 ä¸‡ä¸ªç”µè¯å·ç ï¼Œå¦‚ä½•è¦å¿«é€Ÿå‡†ç¡®çš„åˆ¤æ–­è¿™äº›ç”µè¯å·ç æ˜¯å¦å·²ç»å­˜åœ¨ï¼Ÿ\nä»€ä¹ˆæ˜¯ Bitmapï¼Ÿ Bitmapï¼ˆä½å›¾ï¼‰ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€ç§ä»¥äºŒè¿›åˆ¶ä½ï¼ˆbitï¼‰æ¥è¡¨ç¤ºæ•°æ®çš„ç‰¹æ®Šæ•°æ®ç»“æ„ã€‚ Bitmapæ¡ˆä¾‹ åœ¨ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦è®°å½•æŸç§çŠ¶æ€ï¼Œæ¯”å¦‚ç­¾åˆ°ç³»ç»Ÿä¸­çš„ ç”¨æˆ·ç­¾åˆ°çŠ¶æ€ï¼Œç­”é¢˜ä¸­çš„æ¯é“é¢˜ä½œç­”çŠ¶æ€ï¼Œå¯¹äºè¿™ç§åªæœ‰ä¸¤ç§æƒ…å†µçš„çŠ¶æ€ï¼Œå¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„æ•°æ®ç»“æ„ï¼Œå¾€å¾€éœ€è¦éå¸¸å¤šçš„å­˜å‚¨ç©ºé—´ï¼› æ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨ç”¨æˆ· id æ¥å­˜å‚¨ç”¨æˆ·çŠ¶æ€ï¼Œæ¯”å¦‚ä½¿ç”¨ java ä¸­çš„ intï¼Œæ¯ä¸ª id å°±éœ€è¦ 4 å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼›ä½†æ˜¯ Bitmap é€šè¿‡å°†æ¯ä¸€ä¸ªçŠ¶æ€ï¼ˆ0æˆ–1ï¼‰ç›´æ¥æ˜ å°„ä¸ºä¸€ä¸ªä½ï¼Œå°±å¤§å¤§çš„èŠ‚çœäº†ç©ºé—´ã€‚ BitMap æœ‰è¿™äº›ä¼˜ç‚¹ï¼š\nç©ºé—´æ•ˆç‡å¾ˆé«˜ï¼Œå‡è®¾è¦å­˜å‚¨ä¸€äº¿ä¸ªç”¨æˆ·çš„çŠ¶æ€ï¼Œä½¿ç”¨ Bitmap å°±åªå ç”¨ 12MB çš„å­˜å‚¨ç©ºé—´ã€‚ æŸ¥è¯¢é€Ÿåº¦å¿«ï¼Œä¸ç®¡æŸ¥è¯¢å“ªä¸ªæ•°æ®ï¼Œéƒ½åªéœ€è¦ O(1) çš„æ—¶é—´å¤æ‚åº¦ã€‚ ç®€å•æ˜“ç”¨ï¼Œçœ‹äº†ä¸Šé¢çš„ä»‹ç»ï¼Œå¤§å®¶åº”è¯¥ä¹Ÿèƒ½å®ç°ä¸€ä¸ªç®€å•çš„ Bitmap äº†ï¼Œåœ¨ä½¿ç”¨ä¸­ï¼Œä¹Ÿåªæ˜¯ç®€å•çš„æ’å…¥ã€æŸ¥æ‰¾ã€åˆ é™¤æŒ‡ä»¤ã€‚ ä½†æ˜¯ï¼ŒBitmapåªèƒ½è¡¨ç¤ºä¸¤ç§çŠ¶æ€ï¼Œä¸é€‚åˆéœ€è¦æ›´å¤šçŠ¶æ€è¡¨ç¤ºçš„åœºæ™¯ã€‚ æ­¤å¤–ï¼Œè‹¥æ•°æ®ç¨€ç–ï¼ˆå¦‚ä»…æœ‰å‡ ä¸ªç‰¹å®šä½è¢«è®¾ç½®ï¼‰ï¼Œåˆ™å¯èƒ½å¯¼è‡´æµªè´¹å­˜å‚¨ç©ºé—´ï¼Œæ¯”å¦‚ä¸Šé¢ä¸€äº¿ç”¨æˆ·çš„ä¾‹å­ï¼Œå¯èƒ½åªæœ‰å‡ ä¸ªäººçš„çŠ¶æ€è¢«è®°å½•ï¼Œé‚£å°±ä¼šå¤§é‡æµªè´¹ç©ºé—´ã€‚ å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰ ä»€ä¹ˆæ˜¯å¸ƒéš†è¿‡æ»¤å™¨ ã€ŒWiki-Bloom filterã€ï¼šhttps://en.wikipedia.org/wiki/Bloom_filter å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ª 10 ä¸‡ä½çš„ Bitmapï¼Œæ­¤æ—¶çªç„¶éœ€è¦æˆ‘ä»¬è®°å½•ä¸€ä¸ªåºå·ä¸ºä¸€äº¿çš„çŠ¶æ€ï¼Œæˆ‘ä»¬è¦å°† Bitmap æ‹“å±•åˆ°ä¸€äº¿ä½å—ï¼Ÿ è¿™æ˜¾ç„¶æ˜¯ä¸å¯å–çš„ï¼Œä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡ hash å‡½æ•°å°†è¿™ä¸ªè®°å½•æ˜ å°„æˆ 10 ä¸‡ä»¥å†…çš„æ•°æ®å°±è§£å†³äº†ã€‚ ä½†åªè¦æœ‰å“ˆå¸Œï¼Œå°±æœ‰å“ˆå¸Œç¢°æ’ï¼Œè€Œåªè¦æœ‰å“ˆå¸Œç¢°æ’å°±å¿…ç„¶ä¼šå¼•èµ·è¯¯åˆ¤ï¼Œé‚£æœ‰æ²¡æœ‰æ–¹æ³•èƒ½å¤Ÿå‡å¼±è¿™ç§è¯¯åˆ¤å‘¢ï¼Ÿ å¾ˆç®€å•ï¼Œä¸€ä¸ªå“ˆå¸Œä¸è¡Œï¼Œæˆ‘å¯ä»¥ç”¨ä¸¤ä¸ªï¼Œä¸¤ä¸ªä¸è¡Œæˆ‘å¯ä»¥ç”¨ä¸‰ä¸ªã€‚ã€‚ã€‚ å¸ƒéš†è¿‡æ»¤å™¨æ­£æ˜¯è¿™æ ·åšçš„ï¼Œé€šè¿‡ å¤šä¸ªå“ˆå¸Œå‡½æ•°ï¼Œå°†æ•°æ®æ˜ å°„åˆ°å¤šä¸ªä¸åŒçš„ç´¢å¼•ä½ç½®ï¼Œç„¶åå°†è¿™äº›ç´¢å¼•ä½ç½®é€šé€šç½®ä¸º 1ï¼Œæ£€æŸ¥çš„æ—¶å€™ï¼Œå¦‚æœå‡ ä¸ªä½ç½®éƒ½ä¸º 1ï¼Œé‚£å°±è¯´æ˜å…ƒç´ è‚¯å®šåœ¨åº“ä¸­ã€‚ ä½†è¿™æ ·æ— æ³•å®Œå…¨é¿å…è¯¯åˆ¤ï¼Œæ¯”å¦‚æœ‰ä¸‰ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œè€Œä¸€ä¸ªä¸å­˜åœ¨çš„å…ƒç´ æ˜ å°„çš„ä¸‰ä¸ªä½ç½®éƒ½è¢«ç½®ä¸º 1ï¼Œè¿™ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ï¼Œä½†è¿™ç§æ¦‚ç‡å·²ç»è¢«é™åˆ°äº†å¾ˆå°ã€‚ é‚£ï¼Œç©¶ç«Ÿæœ‰å¤šå°å‘¢ï¼Ÿ\nå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤ç‡æ˜¯å¤šå°‘ï¼Ÿ å‡è®¾å¸ƒéš†è¿‡æ»¤å™¨çš„æ•°ç»„é•¿åº¦ä¸º $m$ï¼Œæ’å…¥å…ƒç´ çš„ä¸ªæ•°ä¸º $n$ï¼Œä½¿ç”¨å“ˆå¸Œå‡½æ•°çš„ä¸ªæ•°ä¸º $k$ã€‚\nå¯¹äºä¸€ä¸ªç‰¹å®šçš„ä½ï¼Œåœ¨æ’å…¥ä¸€ä¸ªå…ƒç´ æ—¶è¢«ç½®ä¸º 1 çš„æ¦‚ç‡ä¸º $p = 1/m$ã€‚\næ’å…¥ $n$ ä¸ªå…ƒç´ åï¼Œè¿™ä¸ªä½ä»ç„¶ä¸º 0 çš„æ¦‚ç‡ä¸º $(1 - p)^{kn}$ã€‚\né‚£ä¹ˆè¿™ä¸ªä½ä¸º 1 çš„æ¦‚ç‡å°±æ˜¯ $1-(1 - p)^{kn}$ã€‚\nå½“æŸ¥è¯¢ä¸€ä¸ªä¸åœ¨é›†åˆä¸­çš„å…ƒç´ æ—¶ï¼Œå¦‚æœç¡®å®šå…¶å­˜åœ¨çš„è¯ï¼Œå¯¹äºæ¯ä¸ªå“ˆå¸Œå‡½æ•°å¯¹åº”çš„ä½éƒ½åº”è¯¥ä¸º 1ï¼Œ$P=(1-(1 - p)^{kn})^{k}$ã€‚\nå°† $p = 1/m$ ä»£å…¥ä¸Šå¼ï¼Œå¯å¾— $P=(1-(1-\\frac{1}{m})^{kn})^{k}$ã€‚\nå¯¹ç»“æœè¿›è¡Œåˆ†æå¯ä»¥å¾—çŸ¥ï¼Œæ•°ç»„é•¿åº¦è¶Šé«˜ï¼Œå“ˆå¸Œå‡½æ•°è¶Šå¤šçš„è¯ï¼Œè¯¯åˆ¤ç‡è¶Šä½ï¼Œä¹Ÿéå¸¸ç¬¦åˆæˆ‘ä»¬çš„ç›´è§‰ã€‚\nå› ä¸º $m$ çš„å€¼ï¼Œä¹Ÿå°±æ˜¯å¸ƒéš†è¿‡æ»¤å™¨çš„å®¹é‡å¯ä»¥éå¸¸å¤§ï¼Œå¯ä»¥è¿‘ä¼¼è®¤ä¸ºè¶‹è¿‘äº $+\\infty$ï¼Œæ­¤æ—¶ä¸Šå¼å¯ä»¥è§†ä¸º $P \\approx (1 - e^\\frac{-kn}{m})^k$\nç»å¤§å¤šæ•°çš„æ—¶é—´ï¼Œæˆ‘ä»¬å…³æ³¨çš„éƒ½æ˜¯è¯¯åˆ¤ç‡å’Œæ’å…¥å…ƒç´ çš„ä¸ªæ•°ï¼Œå³ $P$ å’Œ $n$ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›èƒ½å¤ŸæŒ‡å®šè¿™ä¸¤ä¸ªä¸ªæ•°ï¼Œç„¶åé€šè¿‡è®¡ç®—å¾—å‡ºå“ˆå¸Œå‡½æ•°çš„ä¸ªæ•° k å’Œæ•°ç»„é•¿åº¦ m\né€šè¿‡æ•°å­¦åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå½“Â $k = \\frac{m}{n} \\ln 2$Â æ—¶ï¼Œè¯¯åˆ¤ç‡Â PÂ æœ€å°ï¼Œå°†è¿™ä¸ªå€¼ä»£å…¥ä¸Šé¢çš„å¼å­ï¼Œç®€åŒ–æŒ‡æ•°é¡¹ï¼Œå¯ä»¥å¾—å‡º $P \\approx \\left( 1 - \\frac{1}{2} \\right)^{\\frac{m}{n} \\ln 2}$\nè¿›è€Œå¾—å‡ºï¼š $P \\approx \\left( \\frac{1}{2} \\right)^k$\nå¯ä»¥æ¨å¯¼å‡º $P$ å’Œ $k$ çš„å…³ç³»ï¼Œä¸ºï¼š$k = -\\frac{\\ln P}{\\ln 2}$\nå°†è¿™ä¸ªå¼å­ä»£å…¥ $k = \\frac{m}{n} \\ln 2$ï¼Œå¯ä»¥å¾—å‡º $m$ å’Œ $p$ çš„å…³ç³»ï¼Œ$m = \\frac{n\\ln P}{(\\ln 2)^2}$\nå¸ƒéš†è¿‡æ»¤å™¨çš„ä¼˜ç¼ºç‚¹ é¦–å…ˆï¼Œå®ƒæ˜¯ç”± bit æ•°ç»„æ¥æ„æˆçš„ï¼Œæ‰€å ç©ºé—´å°ã€‚ å’Œ Bitmap ç›¸åŒï¼Œå…¶æ’å…¥å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å‡ä¸º O(1)ã€‚ ä½†æ˜¯ç›¸è¾ƒäº Bitmapï¼Œåªè¦ä½¿ç”¨å“ˆå¸Œï¼Œå°±ä¸å¯é¿å…çš„å­˜åœ¨è¯¯åˆ¤ï¼Œæ‰€ä»¥å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤ï¼Œä½†æ˜¯é€šè¿‡åˆç†çš„å‚æ•°é…ç½®ï¼Œè¯¯åˆ¤ç‡å¯ä»¥æ§åˆ¶åœ¨ä¸€ä¸ªå¯æ¥å—çš„èŒƒå›´å†…ã€‚ åŒæ—¶ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¸å…è®¸åˆ é™¤å…ƒç´ ï¼Œå¦‚æœç®€å•çš„å°†æ‰€æœ‰å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºæ¥çš„ç´¢å¼•ä½ç½®å…¨éƒ¨ç½®ä¸º 1 çš„è¯ï¼Œä¼šå¼•èµ·å¤§èŒƒå›´çš„è¯¯åˆ ã€‚\nGuava æä¾›çš„å¸ƒéš†è¿‡æ»¤å™¨å®ç° ã€ŒGitHubåœ°å€ã€ï¼šhttps://github.com/google/guava Guavaï¼ŒGoogle Java Core Librariesï¼Œæ˜¯è°·æ­Œå¼€å‘çš„ Java æ ¸å¿ƒåº“ã€‚ å†™ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹æ¥å»¶æ—¶ä¸€ä¸‹ Guava æä¾›çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œæµ‹è¯•ç¯å¢ƒä¸º jdk1.8ï¼›\n1 2 3 4 5 6 \u0026lt;!-- å¼•å…¥ guava ä¾èµ– --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.google.guava\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;guava\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;30.1-jre\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; åˆ›å»ºå¸ƒéš†è¿‡æ»¤å™¨ï¼Œä¾é çš„æ˜¯ com.google.common.hash.BloomFilter ç±»æä¾›çš„ create() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š\nFunnelï¼šè´Ÿè´£å°†å¯¹è±¡è½¬ä¸ºä¸€ç³»åˆ—å­—èŠ‚çš„å·¥å…·æ¥å£ï¼Œå³æŒ‡å®šå¸ƒéš†è¿‡æ»¤å™¨ä¸­è¦å­˜æ”¾ä»€ä¹ˆç±»å‹çš„å¯¹è±¡ã€‚ expectedInsertionsï¼šæœŸæœ›æ’å…¥çš„å…ƒç´ ä¸ªæ•°ã€‚ fppï¼šæœŸæœ›çš„è¯¯åˆ¤ç‡ã€‚ 1 2 3 4 public static \u0026lt;T\u0026gt; BloomFilter\u0026lt;T\u0026gt; create( Funnel\u0026lt;? super T\u0026gt; funnel, int expectedInsertions, double fpp) { return create(funnel, (long) expectedInsertions, fpp); } æµ‹è¯•ç±»ï¼Œåœ¨ä¸»æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åå°„æ¥æŸ¥çœ‹ä¸€ä¸‹ Guava ç”Ÿæˆçš„å¸ƒéš†è¿‡æ»¤å™¨å“ˆå¸Œå‡½æ•°ä¸ªæ•°å’Œæ•°ç»„é•¿åº¦ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 /** * é¢„è®¡è¦æ’å…¥å¤šå°‘æ•°æ® 958,5058 100,0000 */ private static final int size = 1000000; /** * æœŸæœ›çš„è¯¯åˆ¤ç‡ */ private static final double fpp = 0.01; /** * å¸ƒéš†è¿‡æ»¤å™¨ */ private static final BloomFilter\u0026lt;Integer\u0026gt; bloomFilter = BloomFilter.create(Funnels.integerFunnel(), size, fpp); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public static void main(String[] args) throws Exception { Class\u0026lt;BloomFilter\u0026gt; bloomFilterClass = BloomFilter.class; // è·å–å“ˆå¸Œå‡½æ•°ä¸ªæ•° Field numHashFunctions = bloomFilterClass.getDeclaredField(\u0026#34;numHashFunctions\u0026#34;); numHashFunctions.setAccessible(true); System.out.println(\u0026#34;å“ˆå¸Œå‡½æ•°ä¸ªæ•° = \u0026#34; + numHashFunctions.get(bloomFilter)); // è·å–æ•°ç»„é•¿åº¦ Method optimalNumOfBits = bloomFilterClass.getDeclaredMethod(\u0026#34;optimalNumOfBits\u0026#34;, long.class, double.class); optimalNumOfBits.setAccessible(true); System.out.println(\u0026#34;å¸ƒéš†è¿‡æ»¤å™¨å¤§å° = \u0026#34; + optimalNumOfBits.invoke(bloomFilter, size, fpp)); // æ’å…¥10ä¸‡æ ·æœ¬æ•°æ® for (int i = 0; i \u0026lt; size; i++) { bloomFilter.put(i); } // ç”¨å¦å¤–åä¸‡æ²¡è¢«æ’å…¥çš„æ•°æ®æµ‹è¯•æ•°æ®ï¼Œæµ‹è¯•è¯¯åˆ¤ç‡ int count = 0; for (int i = size; i \u0026lt; size + 100000; i++) { if (bloomFilter.mightContain(i)) { count++; } } System.out.println(\u0026#34;è¯¯åˆ¤ç‡:\u0026#34; + (double)count / 100000); } è¾“å‡ºç»“æœä¸ºï¼š\n1 2 3 å“ˆå¸Œå‡½æ•°ä¸ªæ•° = 7 å¸ƒéš†è¿‡æ»¤å™¨å¤§å° = 9585058 è¯¯åˆ¤ç‡:0.00947 æ ¹æ®ã€Œå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤ç‡æ˜¯å¤šå°‘ï¼Ÿã€éƒ¨åˆ†çš„æ¨å¯¼ï¼Œç›¸ä¿¡å¤§å®¶å¯¹é€šè¿‡ æœŸæœ›æ’å…¥å…ƒç´ çš„ä¸ªæ•° ä»¥åŠ æœŸæœ›é¢„åˆ¤ç‡ æ˜¯è®¡ç®— bit æ•°ç»„é•¿åº¦å’Œå“ˆå¸Œå‡½æ•°ä¸ªæ•°çš„æ–¹æ³•æœ‰æ‰€äº†è§£äº†ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥å°è¯•è®¡ç®—ä¸€ä¸‹ï¼š\né¦–å…ˆè®¡ç®—ä½æ•°ç»„é•¿åº¦ $m$ï¼š æ ¹æ®å…¬å¼ $m = -\\frac{n * \\ln{p}}{(\\ln{2})^2}$ï¼Œå…¶ä¸­$n = size = 1000000$ï¼Œ$p = fpp = 0.01$ã€‚ å…ˆè®¡ç®—$\\ln{p}=\\ln{0.01}\\approx -4.60517$ã€‚ å†è®¡ç®—$(\\ln{2})^2\\approx0.4804530139182014$ã€‚ åˆ™ $m = -\\frac{1000000 * (-4.60517)}{0.4804530139182014}\\approx9585059.539989209$ã€‚ æ¥ç€è®¡ç®—å“ˆå¸Œå‡½æ•°ä¸ªæ•° $k$ï¼š æ ¹æ®å…¬å¼ $k = \\frac{m}{n} * \\ln{2}$ï¼Œå…¶ä¸­$m\\approx9585059.539989209$ï¼Œ$n = 1000000$ã€‚ å…ˆè®¡ç®— $\\ln{2}\\approx0.6931471805599453$ã€‚ åˆ™ $k=\\frac{9585059.539989209}{1000000} * 0.6931471805599453\\approx6.643859708244697$ï¼Œå–æ•´ä¸º $7$ã€‚ æœ€ç»ˆè®¡ç®—å¾—å‡ºï¼Œä½æ•°ç»„é•¿åº¦çº¦ä¸º $9585059.539989209$ï¼Œå“ˆå¸Œå‡½æ•°ä¸ªæ•°ä¸º $7$ï¼Œå’Œæµ‹è¯•ç»“æœå®Œå…¨å»åˆã€‚ å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼šCuckoo Filter ä»€ä¹ˆæ˜¯å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼Ÿ ã€ŒCuckoo Filter: Practically Better Than Bloomã€ï¼šhttps://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf ã€ŒGitHub åœ°å€ã€ï¼šhttps://github.com/efficient/cuckoofilter ã€ŒWiki-Cuckoo filterã€ï¼šhttps://en.wikipedia.org/wiki/Cuckoo_filter ä¸‹é¢çš„éƒ¨åˆ†æ¥è‡ªå¯¹ GitHub æ¢—æ¦‚éƒ¨åˆ†çš„ç®€å•ç¿»è¯‘ï¼š å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼ˆCuckoo filterï¼‰æ˜¯ä¸€ç§ç”¨äºè¿‘ä¼¼é›†åˆæˆå‘˜æŸ¥è¯¢çš„å¸ƒéš†è¿‡æ»¤å™¨æ›¿ä»£æ–¹æ¡ˆã€‚ å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„èŠ‚çœç©ºé—´çš„æ•°æ®ç»“æ„ï¼Œé€‚åˆç”¨äºå›ç­”â€œå…ƒç´  x æ˜¯å¦åœ¨é›†åˆä¸­ï¼Ÿâ€è¿™æ ·çš„æŸ¥è¯¢ã€‚ä½†å¸ƒéš†è¿‡æ»¤å™¨ä¸æ”¯æŒåˆ é™¤æ“ä½œã€‚ä¸ºäº†æ”¯æŒåˆ é™¤åŠŸèƒ½ï¼Œå¸ƒéš†è¿‡æ»¤å™¨çš„ä¸€äº›å˜ä½“ï¼ˆå¦‚è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼‰é€šå¸¸éœ€è¦æ›´å¤šçš„å­˜å‚¨ç©ºé—´ã€‚ å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æä¾›äº†çµæ´»çš„åŠ¨æ€æ·»åŠ å’Œåˆ é™¤å…ƒç´ çš„èƒ½åŠ›ã€‚å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨åŸºäºå¸ƒè°·é¸Ÿå“ˆå¸Œï¼ˆå› æ­¤å‘½åä¸ºå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼‰ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¸ƒè°·é¸Ÿå“ˆå¸Œè¡¨ï¼Œå­˜å‚¨æ¯ä¸ªå¯†é’¥çš„æŒ‡çº¹ã€‚ å¸ƒè°·é¸Ÿå“ˆå¸Œè¡¨å¯ä»¥éå¸¸ç´§å‡‘ï¼Œå› æ­¤ cuckoo è¿‡æ»¤å™¨å¯ä»¥æ¯”ä¼ ç»Ÿçš„å¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨æ›´å°‘çš„ç©ºé—´ï¼Œä¸”é€‚ç”¨äºéœ€è¦ä½è¯¯æŠ¥ç‡ ï¼ˆ\u0026lt; 3%ï¼‰ çš„åº”ç”¨ç¨‹åºã€‚ å¯ä»¥çœ‹å‡ºï¼Œå¸ƒè°·é¸Ÿåœ¨å¸ƒéš†è¿‡æ»¤å™¨çš„åŸºç¡€ä¸Šï¼Œæä¾›äº† åˆ é™¤ çš„èƒ½åŠ›ï¼Œè€Œä¸”è¿˜ä¼˜åŒ–äº†ç©ºé—´å’Œæ•ˆç‡ã€‚\nå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æ˜¯å¦‚ä½•æ”¯æŒåˆ é™¤çš„ï¼Ÿ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šå“ˆå¸Œè¡¨ã€å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ä¸­çš„æŒ‡çº¹å’Œä¸¤ä¸ªä¸ç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°ã€‚ æ—¢ç„¶è¦åˆ é™¤å…ƒç´ ï¼Œå°†ä¸å¯é¿å…çš„è¦å»å­˜å‚¨è¿™ä¸ªå…ƒç´ æˆ–è€…è¯´å­˜å‚¨æŸä¸ªæ ‡è¯†ï¼Œåœ¨å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ä¸­ï¼Œè¿™ä¸ªå…ƒç´ çš„æ ‡è¯†è¢«ç§°ä¸ºæŒ‡çº¹ï¼ˆfingerprintï¼‰ï¼Œå½“åˆ é™¤çš„æ—¶å€™ï¼Œåªéœ€è¦åˆ é™¤è¿™ä¸ªå…ƒç´ çš„æŒ‡çº¹å°±å¯ä»¥äº†ã€‚\nå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨çš„å®ç°åŸç† åœ¨ GitHub å®˜ç½‘ä¸­æåˆ°ï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨å¯¹å¤–æä¾›äº†è¿™äº› APIï¼š\n1 2 3 4 5 Add(item): å°†å…ƒç´ æ’å…¥è¿‡æ»¤å™¨ã€‚ Contain(item): å¦‚æœå…ƒç´ å·²åœ¨è¿‡æ»¤å™¨ä¸­ï¼Œåˆ™è¿”å›ã€‚è¯·æ³¨æ„ï¼Œå’Œå¸ƒéš†è¿‡æ»¤å™¨ä¸€æ ·ï¼Œæ­¤æ–¹æ³•å¯èƒ½ä¼šè¯¯æŠ¥ã€‚ Delete(item): ä»è¿‡æ»¤å™¨ä¸­åˆ é™¤ç»™å®šçš„é¡¹ç›®ã€‚è¯·æ³¨æ„ï¼Œè¦ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå¿…é¡»ç¡®ä¿æ­¤é¡¹ç›®åœ¨è¿‡æ»¤å™¨ä¸­;å¦åˆ™ï¼Œå¯èƒ½ä¼šè¯¯åˆ ã€‚ Size(): è¿”å›è¿‡æ»¤å™¨ä¸­å½“å‰é¡¹ç›®çš„æ€»æ•°ã€‚ SizeInBytes(): è¿”å›è¿‡æ»¤å™¨å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚ æ’å…¥ï¼ˆAddï¼‰ é‡‡ç”¨ä¼ªä»£ç çš„å½¢å¼ï¼Œæ’å…¥çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š\n1 2 3 4 5 6 7 8 9 fp = getFingerprint(x); p1 = hash1(x); insert(p1); if (å¤±è´¥) { // hash2 ä¿è¯ï¼Œhash2(p2, fp) == p1 p2 = hash2(p1, fp); insert(p2); if (å†æ¬¡å¤±è´¥) æ‰§è¡Œé©±é€ä»£ç  } ä¸å¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨ bit æ•°ç»„ä¸åŒçš„æ˜¯ï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ä½¿ç”¨çš„æ˜¯å“ˆå¸Œæ•°ç»„ï¼ŒæŸä¸€ä¸ªä½ç½®ï¼ˆBucketï¼‰å¯ä»¥å­˜å‚¨å¤šä¸ªæŒ‡çº¹ï¼Œåªæœ‰å½“è¿™ä¸ª Bucket å®Œå…¨è¢«å¡«æ»¡äº†ä¹‹åï¼Œå†å»å°è¯•å…¶ä»–çš„æ–¹æ³•ã€‚ å½“ä¸€ä¸ªå…ƒç´ xè¦æ’å…¥åˆ°å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æ—¶ï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ä¼šå…ˆä½¿ç”¨fingerprintå‡½æ•°è®¡ç®—å‡ºæŒ‡çº¹fpï¼Œæ¥ç€ç”¨ hash1 ç®—æ³•å¯¹è®¡ç®—å¼ç¬¬ä¸€ä¸ªæ¡¶ä½ç½® p1ï¼Œç„¶åå°è¯•å°†æŒ‡çº¹æ’å…¥åˆ° p1 çš„ä½ç½®ï¼› å¦‚æœæ’å…¥å¤±è´¥çš„è¯ï¼Œå†æ¬¡é€šè¿‡ hash2 å‡½æ•°ï¼Œä¼ å…¥ p1 å’Œ fpï¼Œç„¶åå°è¯•å°†æŒ‡çº¹æ’å…¥åˆ° p2 ä½ç½®ã€‚ ä½†å¦‚æœ p2 ä½ç½®ä¹Ÿæ»¡äº†çš„è¯ï¼Œå°±ä¼šè§¦å‘å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨çš„é©±é€ï¼ˆkickoutï¼‰æœºåˆ¶ï¼Œå®ƒä¼šå°†è¿™ä¸ªæ¡¶ä¸­éšæœºçš„ä¸€ä¸ªå…ƒç´ è¸¢å‡ºå»ï¼Œç„¶åç›´æ¥é¸ å é¹Šå·¢ï¼› è¢«è¸¢å‡ºå»çš„è¿™ä¸ªå…ƒç´ å†æ¬¡å»å°è¯•ä¸Šé¢çš„æ­¥éª¤ï¼Œç»§ç»­å¯»æ‰¾ä½ç½®ã€å°è¯•æ’å…¥ã€é©±é€ã€å¯»æ‰¾ä½ç½®ã€‚ã€‚ã€‚ ä½†è¿™ä¸ªè¿‡ç¨‹ä¸æ˜¯æ— ç©·æ— å°½çš„ï¼Œå½“å°è¯•çš„æ¬¡æ•°è¾¾åˆ°æŸä¸ªä¸Šé™çš„æ—¶å€™ï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨å°±ä¼šè®¤ä¸ºè‡ªå·±å·²æ»¡ã€‚ å£è¯´æ— å‡­ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹ä¸€ä¸‹å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨çš„æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 template \u0026lt;typename ItemType, size_t bits_per_item, template \u0026lt;size_t\u0026gt; class TableType, typename HashFamily\u0026gt; Status CuckooFilter\u0026lt;ItemType, bits_per_item, TableType, HashFamily\u0026gt;::Add( const ItemType \u0026amp;item) { size_t i; // p1 uint32_t tag; // æŒ‡çº¹ if (victim_.used) { // æ£€æµ‹æ˜¯å¦è¿˜æœ‰ç©ºé—´ return NotEnoughSpace; } GenerateIndexTagHash(item, \u0026amp;i, \u0026amp;tag); return AddImpl(i, tag); } // è®¡ç®—ç´¢å¼• 1 å’Œ æŒ‡çº¹ tag inline void GenerateIndexTagHash(const ItemType\u0026amp; item, size_t* index, uint32_t* tag) const { const uint64_t hash = hasher_(item); *index = IndexHash(hash \u0026gt;\u0026gt; 32); *tag = TagHash(hash); } é¦–å…ˆé€šè¿‡ victim_.used åˆ¤æ–­æ˜¯å¦ä¸ºæ»¡ï¼Œä¸ºä»€ä¹ˆå¯ä»¥åˆ¤æ–­æ”¾åˆ°åé¢å»è®²è§£ã€‚ ç„¶åé€šè¿‡ GenerateIndexTagHash ç”Ÿæˆä¸‹æ ‡ 1 å’ŒæŒ‡çº¹ã€‚ è°ƒç”¨ AddImpl å°†å…ƒç´ æ·»åŠ åˆ°å“ˆå¸Œè¡¨ä¸­ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 template \u0026lt;typename ItemType, size_t bits_per_item, template \u0026lt;size_t\u0026gt; class TableType, typename HashFamily\u0026gt; Status CuckooFilter\u0026lt;ItemType, bits_per_item, TableType, HashFamily\u0026gt;::AddImpl( const size_t i, const uint32_t tag) { size_t curindex = i; // å½“å‰æ’å…¥å…ƒç´ çš„ä¸‹æ ‡ uint32_t curtag = tag; // å½“å‰æ’å…¥å…ƒç´ çš„æŒ‡çº¹ uint32_t oldtag; // æš‚å­˜è¢«é©±é€çš„å…ƒç´ æŒ‡çº¹ for (uint32_t count = 0; count \u0026lt; kMaxCuckooCount; count++) { bool kickout = count \u0026gt; 0; // é©±é€å¼€å§‹çš„æ—¶æœºï¼šè®¡ç®—æ›¿ä»£ç´¢å¼•ä¹‹å oldtag = 0; if (table_-\u0026gt;InsertTagToBucket(curindex, curtag, kickout, oldtag)) { // æ’å…¥æˆåŠŸçš„è¯ï¼Œè®¡æ•° num_items_++; return Ok; } // å¦‚æœæ²¡æœ‰æ’å…¥ï¼Œè¯´æ˜éœ€è¦é©±é€ï¼Œå°† curtag è®¾ç½®ä¸ºè¢«é©±é€çš„å…ƒç´  if (kickout) { curtag = oldtag; } // è®¡ç®—æ›¿ä»£ç´¢å¼• curindex = AltIndex(curindex, curtag); } // å¦‚æœæœ€ç»ˆè¿˜æ²¡æœ‰æ’å…¥æˆåŠŸï¼Œè§†ä¸ºæ»¡äº†ï¼Œåšäº›å–„åå·¥ä½œ victim_.index = curindex; victim_.tag = curtag; victim_.used = true; return Ok; } ä¸Šé¢åˆ—å‡ºçš„å°±æ˜¯æ’å…¥å…ƒç´ çš„å…·ä½“å®ç°\nå¦‚æœç¬¬ä¸€æ¬¡å°±æ’å…¥æˆåŠŸï¼Œä¹Ÿå°±æ˜¯ table_-\u0026gt;InsertTagToBucket(curindex, curtag, kickout, oldtag) è¯­å¥æ‰§è¡ŒæˆåŠŸï¼Œç›´æ¥è¿”å› OKã€‚ å¦‚æœç¬¬ä¸€æ¬¡æ²¡æœ‰æ’å…¥æˆåŠŸï¼Œæ¥ä¸‹æ¥çš„æ’å…¥æ“ä½œéƒ½å°†è¿›å…¥é©±é€æ¨¡å¼ï¼Œå³å¦‚æœæ²¡æœ‰ç©ºä½ç½®ï¼Œå°±å°†åŸä½ç½®çš„å…ƒç´ ç›´æ¥è¸¢å‡ºï¼ŒInsertTagToBucket(curindex, curtag, kickout, oldtag) å°†ä¼šå°† oldtag è®¾ç½®ä¸ºè¸¢å‡ºçš„å…ƒç´ ï¼Œç„¶åç»§ç»­æ‰§è¡Œæ’å…¥æ“ä½œã€‚ å¦‚æœåˆ°æœ€åè¿˜æ˜¯æ²¡æœ‰æˆåŠŸï¼Œå¯ä»¥è§†ä¸ºè¿‡æ»¤å™¨å·²ç»æ»¡äº†ï¼Œæ­¤æ—¶ victim_.used = true;ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šé¢å¯ä»¥é€šè¿‡ victim_.used æ¥åˆ¤æ–­è¿‡æ»¤å™¨æ˜¯å¦æ»¡çš„åŸå› ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 inline bool InsertTagToBucket(const size_t i, const uint32_t tag, const bool kickout, uint32_t \u0026amp;oldtag) { for (size_t j = 0; j \u0026lt; kTagsPerBucket; j++) { if (ReadTag(i, j) == 0) { WriteTag(i, j, tag); return true; } } if (kickout) { size_t r = rand() % kTagsPerBucket; oldtag = ReadTag(i, r); WriteTag(i, r, tag); } return false; } æ’å…¥æ–¹æ³•ï¼šInsertTagToBucketï¼Œ å…ˆå°è¯•åœ¨ç´¢å¼•ä½ç½®æ’å…¥å…ƒç´ ï¼Œå¦‚æœæ’å…¥å¤±è´¥ï¼Œä¸”å½“å‰ä¸æ˜¯é©±é€æ¨¡å¼ï¼Œç›´æ¥è¿”å›ï¼› å¦‚æœå½“å‰æ˜¯é©±é€æ¨¡å¼ï¼Œå°†éšæœºä¸€ä¸ªå…ƒç´ å­˜å‚¨åœ¨ oldtag ä¸­ï¼Œç„¶åå°†å…ƒç´ æ’å…¥åˆ°é‚£ä¸ªä½ç½®\n1 2 3 4 5 inline size_t AltIndex(const size_t index, const uint32_t tag) const { // NOTE(binfan): originally we use: // index ^ HashUtil::BobHash((const void*) (\u0026amp;tag), 4)) \u0026amp; table_-\u0026gt;INDEXMASK; // now doing a quick-n-dirty way: // 0x5bd1e995 is the hash constant from MurmurHash2 return IndexHash((uint32_t)(index ^ (tag * 0x5bd1e995))); } AltIndex å‡½æ•°æ ¹æ®è®¡ç®—å‡ºçš„ä¸»ç´¢å¼• index å’Œæ ‡ç­¾ tag è®¡ç®—ä¸€ä¸ªæ›¿ä»£ç´¢å¼•ã€‚å®ƒé€šè¿‡å¯¹ä¸»ç´¢å¼• index å’Œæ ‡ç­¾ tag ä¹˜ä»¥ä¸€ä¸ªå¸¸æ•° 0x5bd1e995 åè¿›è¡Œå¼‚æˆ–ï¼ˆ^ï¼‰è¿ç®—ï¼Œå†é€šè¿‡ IndexHash è®¡ç®—å‡ºæ›¿ä»£ä½ç½®ã€‚ ç›¸æ¯”äºä¹‹å‰çš„å¼‚æˆ–æ“ä½œï¼ˆä¹Ÿæ˜¯ç°åœ¨ç½‘ä¸Šå¤§éƒ¨åˆ†çš„è§£é‡Šï¼‰ï¼Œè¿™ç§åšæ³•åœ¨å®ç°ç®€å•çš„åŒæ—¶ä¾ç„¶å…·æœ‰è‰¯å¥½çš„åˆ†å¸ƒç‰¹æ€§ï¼Œç¡®ä¿å…ƒç´ èƒ½åœ¨è¾ƒå°çš„è¡¨ä¸­åˆ†å¸ƒå‡åŒ€ï¼ŒåŒæ—¶è¿™ä¸ªæ“ä½œæ˜¯å¯é€†çš„ï¼Œå³é€šè¿‡ p2 ä¹Ÿèƒ½å¾—åˆ° p2ã€‚\næŸ¥è¯¢æ˜¯å¦å­˜åœ¨ï¼ˆContainï¼‰ çœ‹æ‡‚äº† Add æ–¹æ³•ï¼Œåé¢å°±éå¸¸å®¹æ˜“ç†è§£äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 template \u0026lt;typename ItemType, size_t bits_per_item, template \u0026lt;size_t\u0026gt; class TableType, typename HashFamily\u0026gt; Status CuckooFilter\u0026lt;ItemType, bits_per_item, TableType, HashFamily\u0026gt;::Contain( const ItemType \u0026amp;key) const { bool found = false; size_t i1, i2; uint32_t tag; GenerateIndexTagHash(key, \u0026amp;i1, \u0026amp;tag); i2 = AltIndex(i1, tag); assert(i1 == AltIndex(i2, tag)); found = victim_.used \u0026amp;\u0026amp; (tag == victim_.tag) \u0026amp;\u0026amp; (i1 == victim_.index || i2 == victim_.index); if (found || table_-\u0026gt;FindTagInBuckets(i1, i2, tag)) { return Ok; } else { return NotFound; } } ä¸Šé¢çš„æ–¹æ³•å°±æ˜¯è®¡ç®— i1 å’Œ i2ï¼Œç„¶åå»è¿™ä¸¤ä¸ªä½ç½®å¯»æ‰¾ï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œè¿”å› trueã€‚ found = victim_.used \u0026amp;\u0026amp; (tag == victim_.tag) \u0026amp;\u0026amp; (i1 == victim_.index || i2 == victim_.index); æ˜¯ä¸ºäº†åœ¨è¿‡æ»¤å™¨æ»¡äº†ä¹‹åæ’å…¥çš„é‚£ä¸ªå…ƒç´ å¯ä»¥è¢«æ£€ç´¢åˆ°ã€‚\nåˆ é™¤æ“ä½œï¼ˆDeleteï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 template \u0026lt;typename ItemType, size_t bits_per_item, template \u0026lt;size_t\u0026gt; class TableType, typename HashFamily\u0026gt; Status CuckooFilter\u0026lt;ItemType, bits_per_item, TableType, HashFamily\u0026gt;::Delete( const ItemType \u0026amp;key) { // ç”Ÿæˆç´¢å¼• size_t i1, i2; uint32_t tag; GenerateIndexTagHash(key, \u0026amp;i1, \u0026amp;tag); i2 = AltIndex(i1, tag); // å°è¯•åˆ é™¤å…ƒç´ ï¼Œåˆ é™¤æˆåŠŸçš„è¯ï¼Œè·³åˆ° TryEliminateVictim å»å°è¯•æ¸…æ¥šå—å®³è€…å…ƒç´  if (table_-\u0026gt;DeleteTagFromBucket(i1, tag)) { num_items_--; goto TryEliminateVictim; } else if (table_-\u0026gt;DeleteTagFromBucket(i2, tag)) { num_items_--; goto TryEliminateVictim; } else if (victim_.used \u0026amp;\u0026amp; tag == victim_.tag \u0026amp;\u0026amp; (i1 == victim_.index || i2 == victim_.index)) { // num_items_--; victim_.used = false; return Ok; } else { return NotFound; } TryEliminateVictim: // æ¸…é™¤å—å®³è€… if (victim_.used) { victim_.used = false; size_t i = victim_.index; uint32_t tag = victim_.tag; AddImpl(i, tag); } return Ok; } è¿˜æ˜¯å…ˆç”Ÿæˆä¸¤ä¸ªç´¢å¼•ä½ç½®ï¼Œé¦–å…ˆåœ¨ç´¢å¼• i1 çš„æ¡¶ä¸­å°è¯•åˆ é™¤ tagï¼Œå¦‚æœæˆåŠŸæ‰¾åˆ°å¹¶åˆ é™¤ï¼Œè®¡æ•° num_items_ å‡ 1ï¼Œå¹¶è·³åˆ° TryEliminateVictimã€‚ å¦‚æœ i1 åˆ é™¤å¤±è´¥ï¼Œåˆ™åœ¨ i2 çš„æ¡¶ä¸­å°è¯•åˆ é™¤ tagã€‚è‹¥æ‰¾åˆ°å¹¶åˆ é™¤ï¼Œnum_items_ å‡ 1ï¼Œå¹¶è·³åˆ° TryEliminateVictimã€‚ TryEliminateVictim æ–¹æ³•ä¼šå°è¯•æ¸…é™¤ä¸€ä¸ªå—å®³è€…ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªå—å®³è€…é¡¹ä¹Ÿå°±æ˜¯æ»¡äº†ä¹‹åæ’å…¥çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆvictim_ï¼‰ï¼Œå®ƒä¼šå°è¯•é‡æ–°æ·»åŠ è¯¥å—å®³è€…é¡¹åˆ°è¡¨ä¸­ã€‚ç„¶åè®¾ç½® victim_.used ä¸º falseï¼Œç„¶åè°ƒç”¨ AddImpl(i, tag) å°† victim_ é¡¹æ”¾å…¥å…¶ç´¢å¼• i ä½ç½®å¦‚æœä¸Šè¿°ä¸¤æ­¥å‡æœªæˆåŠŸï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ªå¾…å¤„ç†çš„å—å®³è€…é¡¹ï¼ˆvictim_ï¼‰ï¼Œå¦‚æœè¯¥å—å®³è€…é¡¹åŒ¹é… tag å¹¶ä¸”å…¶ç´¢å¼•ä¸º i1 æˆ– i2ï¼Œåˆ™æ¸…é™¤ victim_ å¹¶è¿”å› Okï¼Œè¡¨ç¤ºåˆ é™¤æˆåŠŸã€‚\nå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨èƒ½å¤Ÿæ›¿ä»£å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ä¹Ÿæœ‰è‡ªå·±çš„ç¼ºé™·ï¼Œä¸”ç›®å‰è¿˜æ— æ³•æ›¿ä»£å¸ƒéš†è¿‡æ»¤å™¨ï¼š\nå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨è¦æ±‚å­˜å‚¨ç©ºé—´å¿…é¡»ä¸º 2 çš„å¹‚æ¬¡ï¼Œå…¶å®¹é‡è®¡ç®—çš„æ–¹å¼ä¸ºï¼šupperpower2(std::max\u0026lt;uint64_t\u0026gt;(1, max_num_keys / assoc))ï¼Œ upperpower2å‡½æ•°ç”¨äºè®¡ç®—å¤§äºæˆ–ç­‰äºç»™å®šå€¼ x çš„æœ€å°çš„2çš„å¹‚ã€‚ éšç€å…ƒç´ ä¸ªæ•°çš„å¢åŠ ï¼Œå‘ç”Ÿ kickout çš„æ¦‚ç‡ä¹Ÿä¼šå¢åŠ ï¼Œå¯¼è‡´å…ƒç´ æ’å…¥æ—¶é—´å˜æ…¢ã€‚ å¯¹äºåŒä¸€ä¸ªå…ƒç´ ï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æœ€å¤šå­˜å‚¨ $2 * k$ æ¬¡ï¼Œk ä¸ºæ¡¶çš„å®¹é‡ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°ï¼Œæ’å…¥å¿…å°†ä¼šå¤±è´¥ã€‚ å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨åˆ é™¤çš„æ˜¯æŒ‡çº¹å‰¯æœ¬ï¼Œè€Œæ— æ³•å®Œå…¨ç¡®å®šè¿™ä¸ªæŒ‡çº¹æ˜¯å±äºéœ€è¦åˆ é™¤çš„å…ƒç´ çš„ã€‚ ä¸å…¶ä»–è¿‡æ»¤å™¨çš„æ¯”è¾ƒ ![[å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ä¸å…¶ä»–è¿‡æ»¤å™¨åœ¨ç©ºé—´æ•ˆç‡ä¸Šçš„æ¯”è¾ƒ.png|800]] ä¸Šå›¾å‡ºè‡ªã€ŒCuckoo Filter: Practically Better Than Bloomã€ï¼Œç”±æ­¤å¯çŸ¥ï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨åœ¨ç»´æŠ¤ä½è¯¯åˆ¤ç‡éœ€è¦çš„ç©ºé—´æˆæœ¬ä¸Šæ¯”å¸ƒéš†è¿‡æ»¤å™¨æ›´ä½ã€‚\n","date":"2024-11-17T00:00:00Z","image":"http://localhost:64097/p/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E8%AF%A6%E8%A7%A3/image_hu16033865038594683048.png","permalink":"http://localhost:64097/p/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E8%AF%A6%E8%A7%A3/","title":"å¸ƒéš†è¿‡æ»¤å™¨è¯¦è§£"},{"content":"è¿™éƒ¨åˆ†æˆ‘ä»¬æ¥å…·ä½“çš„çœ‹ä¸€ä¸‹ Spring AOP å®ç°ä¸­ï¼Œä»£ç†ç±»ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ—¶å€™è¢«æ„å»ºçš„ã€‚\næ¡ˆä¾‹å‡†å¤‡ maven pom æ–‡ä»¶ spring.versionï¼š5.3.22 java.versionï¼š1.8 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;!-- Springæ ¸å¿ƒåº“ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Spring IoCå®¹å™¨ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-beans\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Springä¸Šä¸‹æ–‡æ”¯æŒï¼Œæä¾›äº†BeanFactoryçš„æ‰©å±• --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-context\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; Service æ¥å£ä¸å®ç°ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public interface IUserService { void queryUserName(String uId); void queryUserId(String name); } public class UserService implements IUserService { @Override public void queryUserName(String uId) { System.out.println(\u0026#34;æŸ¥è¯¢ç”¨æˆ·åç§°ä¸ºï¼šryan\u0026#34;); } @Override public void queryUserId(String name) { System.out.println(\u0026#34;æŸ¥è¯¢ç”¨æˆ·IDä¸ºï¼š10001\u0026#34;); } } é€šçŸ¥ç±» 1 2 3 4 5 6 7 8 9 10 11 public class LogAdvices { public void before() { System.out.println(\u0026#34;before\u0026#34;); } public void after() { System.out.println(\u0026#34;after\u0026#34;); } } ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæœ¬æ–‡æ‰€æœ‰çš„ Bean éƒ½ä¼šé€šè¿‡é…ç½®æ–‡ä»¶æ¥é…ç½®ã€‚ Main æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 public class Main { public static void main(String[] args) { ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext(\u0026#34;spring-aop.xml\u0026#34;); IUserService service = applicationContext.getBean(\u0026#34;userService\u0026#34;, IUserService.class); System.out.println(service.getClass()); service.queryUserName(\u0026#34;10001\u0026#34;); } } spring xml é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;beans xmlns=\u0026#34;http://www.springframework.org/schema/beans\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:aop=\u0026#34;http://www.springframework.org/schema/aop\u0026#34; xsi:schemaLocation=\u0026#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop https://www.springframework.org/schema/aop/spring-aop.xsd\u0026#34;\u0026gt; \u0026lt;bean id=\u0026#34;userService\u0026#34; class=\u0026#34;com.ryan.aop_test.service.impl.UserService\u0026#34;/\u0026gt; \u0026lt;bean id=\u0026#34;logAspect\u0026#34; class=\u0026#34;com.ryan.aop_test.LogAdvices\u0026#34; /\u0026gt; \u0026lt;aop:config\u0026gt; \u0026lt;aop:pointcut id=\u0026#34;point1\u0026#34; expression=\u0026#34;execution(* com.ryan.aop_test.service.*.*(..))\u0026#34; /\u0026gt; \u0026lt;aop:aspect ref=\u0026#34;logAspect\u0026#34;\u0026gt; \u0026lt;aop:before method=\u0026#34;before\u0026#34; pointcut-ref=\u0026#34;point1\u0026#34;/\u0026gt; \u0026lt;aop:after-returning method=\u0026#34;after\u0026#34; pointcut-ref=\u0026#34;point1\u0026#34; /\u0026gt; \u0026lt;/aop:aspect\u0026gt; \u0026lt;/aop:config\u0026gt; \u0026lt;/beans\u0026gt; å…³äº spring é€šè¿‡ xml é…ç½® aop çš„å…·ä½“å†…å®¹å¯ä»¥å‚ç…§å®˜ç½‘ï¼š\næ–‡æ¡£åœ°å€ï¼šhttps://docs.spring.io/spring-framework/docs/5.2.25.RELEASE/spring-framework-reference/core.html#aop-schema éœ€è¦æ³¨æ„ï¼Œè¿™ç§æ–¹å¼ä½¿ç”¨çš„æ˜¯ Spring çš„è‡ªåŠ¨ä»£ç†æœºåˆ¶ï¼Œå¦‚æœæœ‰ç±»ä¼¼ BeanNameAutoProxyCreator æˆ–ç±»ä¼¼çš„ç±»ä½¿ç”¨äº†æ˜¾ç¤ºçš„ä»£ç†ï¼Œä¼šå¯¼è‡´å…¶ä¸­çš„æŸä¸€é¡¹å¤±æ•ˆã€‚ å»ºè®®çš„ä½¿ç”¨æ–¹å¼æ˜¯ä»…ä½¿ç”¨\u0026lt;aop:config\u0026gt;æ ·å¼æˆ–ä»…ä½¿ç”¨AutoProxyCreatoræ ·å¼ï¼Œå¹¶ä¸”åˆ‡å‹¿æ··åˆä½¿ç”¨å®ƒä»¬ã€‚\næ‰§è¡Œç»“æœ å…ˆæ¥çœ‹ä¸€ä¸‹ä¸Šé¢çš„ Main æ–¹æ³•æ‰§è¡Œåçš„æ•ˆæœï¼š\n1 2 3 4 class com.sun.proxy.$Proxy3 before æŸ¥è¯¢ç”¨æˆ·åç§°ä¸ºï¼šryan after å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è·å–åˆ°çš„ç±»æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œå¹¶ä¸”ä»£ç†æ–¹æ³•å·²ç»æ‰§è¡ŒæˆåŠŸäº†ã€‚\næºç åˆ†æ XML è§£æ å½“æ‰§è¡Œä¸‹é¢è¿™æ¡è¯­å¥ä¹‹åï¼š\n1 ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext(\u0026#34;spring-aop.xml\u0026#34;); ä¼šæ‰§è¡Œ ClassPathXmlApplicationContext çš„ refresh æ–¹æ³•ï¼š org.springframework.context.support.AbstractApplicationContext#refresh()\n1 2 3 4 5 6 7 8 9 10 11 12 13 @Override public void refresh() throws BeansException, IllegalStateException { synchronized (this.startupShutdownMonitor) { StartupStep contextRefresh = this.applicationStartup.start(\u0026#34;spring.context.refresh\u0026#34;); // Prepare this context for refreshing. prepareRefresh(); // Tell the subclass to refresh the internal bean factory. ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // ...... } å…¶ä¸­ obtainFreshBeanFactory ä¼šæ‰§è¡Œ Bean å·¥å‚çš„åˆå§‹åŒ–ï¼Œå…¶ä¸­æœ€é‡è¦çš„éƒ¨åˆ†å°±æ˜¯å°† XML é…ç½®æ–‡ä»¶ä¸­çš„ Bean å®šä¹‰ï¼ˆBean Definitionï¼‰åŠ è½½åˆ° Bean å·¥å‚ä¸­ã€‚\n1 2 3 4 5 6 org.springframework.context.support.AbstractApplicationContext#refresh() =\u0026gt; org.springframework.context.support.AbstractRefreshableApplicationContext#refreshBeanFactory() =\u0026gt; org.springframework.context.support.AbstractXmlApplicationContext#loadBeanDefinitions(DefaultListableBeanFactory beanFactory) ä¸Šé¢çš„æ˜¯ä» `refresh()` æ–¹æ³•åˆ°å…·ä½“åŠ è½½ Bean Definition æ–¹æ³•çš„è°ƒç”¨é“¾è·¯ã€‚ org.springframework.context.support.AbstractXmlApplicationContext#loadBeanDefinitions(DefaultListableBeanFactory beanFactory) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Override protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException { // Create a new XmlBeanDefinitionReader for the given BeanFactory. XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); // Configure the bean definition reader with this context\u0026#39;s // resource loading environment. beanDefinitionReader.setEnvironment(this.getEnvironment()); beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); // Allow a subclass to provide custom initialization of the reader, // then proceed with actually loading the bean definitions. initBeanDefinitionReader(beanDefinitionReader); loadBeanDefinitions(beanDefinitionReader); } å…·ä½“è§£æ XML å’ŒåŠ è½½ Bean Definition çš„æ–¹æ³• å…³äºå…·ä½“æ˜¯å¦‚ä½•è§£æ XML çš„ï¼Œè¿™é‡Œå°±ä¸ç»†çœ‹äº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä¸€ä¸‹ä»æˆ‘ä»¬çš„ XML é…ç½®æ–‡ä»¶ä¸­å¯ä»¥è§£æåˆ°ä»€ä¹ˆ é…ç½®æ–‡ä»¶ï¼š[[ğŸ—ºï¸ã€spring-aopã€‘Spring ä»£ç†ç±»åˆ›å»ºæµç¨‹æ¢³ç†#spring xml é…ç½®æ–‡ä»¶]]\n1 2 3 4 5 6 7 beanDefinitionNames = {ArrayList@1626} size = 6 0 = \u0026#34;userService\u0026#34; 1 = \u0026#34;logAspect\u0026#34; 2 = \u0026#34;org.springframework.aop.config.internalAutoProxyCreator\u0026#34; 3 = \u0026#34;point1\u0026#34; 4 = \u0026#34;org.springframework.aop.aspectj.AspectJPointcutAdvisor#0\u0026#34; 5 = \u0026#34;org.springframework.aop.aspectj.AspectJPointcutAdvisor#1\u0026#34; é™¤äº†è¿™äº› infrastructureï¼Œä¸Šé¢è¿˜æœ‰ä¸€ä¸ª åç§° ä¸ºorg.springframework.aop.config.internalAutoProxyCreator çš„ Beanã€‚ è¿™ä¸ª Bean çš„å®é™…ç±»å‹æ˜¯ï¼šorg.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreatorï¼Œå®ƒæ˜¯ä¸€ä¸ª InstantiationAwareBeanPostProcessorï¼ŒAbstractAdvisorAutoProxyCreator ç±»å®ç°äº†ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼š\n1 2 3 default Object postProcessBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName) throws BeansException { return null; } è¿™ä¸ªæ–¹æ³•ä¼šåœ¨ Bean çš„å®ä¾‹åŒ–å‰è¢«è°ƒç”¨ï¼Œå¯ä»¥ç”¨äºä¿®æ”¹å’Œåˆ›å»º Bean å¯¹è±¡ã€‚ é™¤æ­¤ä¹‹å¤–ï¼ŒAbstractAdvisorAutoProxyCreator è¿˜å®ç°äº† BeanPostProcessor æ¥å£çš„ postProcessAfterInitializationï¼Œåœ¨ Bean å¯¹è±¡æ‰§è¡Œå®Œåˆå§‹åŒ–æ–¹æ³•åï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ£€æµ‹æ˜¯å¦éœ€è¦å°†å…¶è½¬åŒ–ä¸ºä»£ç†å¯¹è±¡ã€‚ AbstractAdvisorAutoProxyCreator æ˜¯ AOP ä»£ç†ä¸­éå¸¸å…³é”®çš„ä¸€ä¸ªç±»ï¼Œæ•´ä¸ªåˆ›å»º AOP ä»£ç†çš„æ ¸å¿ƒæµç¨‹å°±æ˜¯å…¶æ‰§è¡Œçš„è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚\nåŠ è½½ Creator ä¸Šé¢æåˆ°ï¼Œorg.springframework.aop.config.internalAutoProxyCreator æ˜¯ä¸€ä¸ª BeanPostProcessorï¼Œé‚£å®ƒå…·ä½“åˆ›å»ºå¹¶æ³¨å†Œçš„ä½ç½®å°±æ˜¯ï¼š org.springframework.context.support#registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„ä½ç½®è¿˜æ˜¯ ApplicationContext çš„ refresh() æ–¹æ³•ï¼Œå…·ä½“çš„è°ƒç”¨é“¾è·¯ä¸ºï¼š\n1 2 3 org.springframework.context.support.AbstractApplicationContext#refresh() =\u0026gt; org.springframework.context.support.AbstractApplicationContext#registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) =\u0026gt; org.springframework.context.support.PostProcessorRegistrationDelegate#registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) å…·ä½“å°±æ˜¯å°† BeanPostProcessor åŠ è½½åˆ°å·¥å‚ä¸­ï¼Œæ–¹ä¾¿åç»­çš„è°ƒç”¨ã€‚ å…·ä½“å­˜æ”¾ BeanPostProcessor çš„ä½ç½®ä¸ºï¼šorg.springframework.beans.factory.support.AbstractBeanFactory çš„ beanPostProcessors å±æ€§ã€‚\nåŠ è½½ Advisors åœ¨ã€ŒXML è§£æã€éƒ¨åˆ†ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† spring ä¸ºæˆ‘ä»¬å°† xml ä¸­å®šä¹‰çš„ \u0026lt;acp:config /\u0026gt; è§£æä¸ºå…·ä½“çš„ Bean å®šä¹‰ã€‚ å¹¶ä¸”åœ¨ã€ŒåŠ è½½ Creatorã€éƒ¨åˆ†ï¼Œspring å·²ç»å°† AOP åˆ›å»ºè€…ç±»æ³¨å†Œæˆäº†ä¸€ä¸ª InstantiationAwareBeanPostProcessorã€‚ åœ¨å°†å•ä¾‹ Beanï¼ˆåŸå‹ Bean ä¹Ÿå¯ä»¥è¢«ä»£ç†ï¼Œæœ¬æ–‡åªå…³æ³¨å•ä¾‹ Bean çš„ä»£ç†è¿‡ç¨‹ï¼‰åŠ è½½ä»£ç†ä¹‹å‰ï¼Œè‚¯å®šæ˜¯è¦å°†ä¸Šé¢ \u0026lt;acp:config /\u0026gt; ä¸­é…ç½®çš„ Bean æ„å»ºå‡ºæ¥çš„ã€‚ è€Œå¦‚æœæŒ‰ç…§æˆ‘ä»¬åœ¨ xml ä¸­é…ç½®çš„æ–¹å¼ï¼Œæ˜¾ç„¶å…ˆæ„å»ºçš„ Bean å°†ä¼šæ˜¯ userServiceã€‚ æ‰€ä»¥åœ¨æ‰€æœ‰çš„ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿è¿™äº›æ„å»º AOP çš„ infrastructure è¢«æå‰æ„å»ºå¥½ï¼Œè¿™å°±æ˜¯ AbstractAdvisorAutoProxyCreator åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œçš„é€»è¾‘ã€‚ æˆ‘ä»¬ä¾ç„¶ä» refresh() æ–¹æ³•å¼€å§‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 org.springframework.context.support.AbstractApplicationContext#refresh() =\u0026gt; org.springframework.context.support.AbstractApplicationContext#finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) =\u0026gt; org.springframework.beans.factory.support.DefaultListableBeanFactory#preInstantiateSingletons() åœ¨é¢„å…ˆå®ä¾‹åŒ–å•ä¾‹ Bean çš„æ–¹æ³•ä¸­ï¼Œä¼šå¯¹æ‰€æœ‰çš„ Bean æ‰§è¡Œ `getBean()` æ–¹æ³•ï¼Œ`getBean()` æ–¹æ³•å¦‚æœå‘ç° Bean æ²¡æœ‰è¢«åŠ è½½æˆ–è€…ä¸ºåŸå‹ Beanï¼Œå°†ä¼šè§¦å‘ Bean çš„åŠ è½½ã€‚ =\u0026gt; org.springframework.beans.factory.support.AbstractBeanFactory.getBean(String name) =\u0026gt; org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(String name, @Nullable Class\u0026lt;T\u0026gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly) =\u0026gt; org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) Bean çš„ `createBean()` æ–¹æ³•å®é™…ä¸Šæ˜¯å»¶è¿Ÿè°ƒç”¨çš„ï¼Œåç»­åœ¨ spring ä¸‰çº§ç¼“å­˜ä¸­ä¼šå…·ä½“è®²è§£ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥è§†ä¸ºç›´æ¥è°ƒç”¨äº† `createBean() æ–¹æ³• =\u0026gt; org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd) =\u0026gt; org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName) è¿™é‡Œå°±æ˜¯å…·ä½“æ‰§è¡Œ BeanPostProcessor çš„ä½ç½®ï¼š\n1 2 3 4 5 6 7 8 9 protected Object applyBeanPostProcessorsBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName) { for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) { Object result = bp.postProcessBeforeInstantiation(beanClass, beanName); if (result != null) { return result; } } return null; } åœ¨è¿™é‡Œä¼šéå†æ‰€æœ‰çš„ BeanPostProcessorï¼Œç„¶åè°ƒç”¨å…¶ postProcessBeforeInstantiationï¼Œä¸Šé¢çš„ AbstractAdvisorAutoProxyCreator çš„è¯¥æ–¹æ³•å°±æ˜¯åœ¨è¿™é‡Œè°ƒç”¨çš„ã€‚\norg.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#postProcessBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 @Override public Object postProcessBeforeInstantiation(Class\u0026lt;?\u0026gt; beanClass, String beanName) { Object cacheKey = getCacheKey(beanClass, beanName); if (!StringUtils.hasLength(beanName) || !this.targetSourcedBeans.contains(beanName)) { if (this.advisedBeans.containsKey(cacheKey)) { return null; } if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) { this.advisedBeans.put(cacheKey, Boolean.FALSE); return null; } } // å¦‚æœæœ‰è‡ªå®šä¹‰çš„ TargetSourceï¼Œåˆ™åœ¨è¿™é‡Œåˆ›å»ºä»£ç†å¯¹è±¡ TargetSource targetSource = getCustomTargetSource(beanClass, beanName); if (targetSource != null) { if (StringUtils.hasLength(beanName)) { this.targetSourcedBeans.add(beanName); } Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource); Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; } return null; } åœ¨ä¸Šé¢çš„ shouldSkip() æ–¹æ³•ä¸­ï¼Œä¼šå°è¯•å»è·å–æ‰€æœ‰çš„ Advisorï¼Œæœªåˆ›å»ºçš„è¯ï¼Œåˆ™ä¼šå»å°è¯•åˆ›å»ºè¿™äº› Advisorã€‚\n1 2 3 org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#shouldSkip(Class\u0026lt;?\u0026gt; beanClass, String beanName) =\u0026gt; org.springframework.aop.framework.autoproxy.AspectJAwareAdvisorAutoProxyCreator#findCandidateAdvisors() =\u0026gt; org.springframework.aop.framework.autoproxy.BeanFactoryAdvisorRetrievalHelper#findAdvisorBeans() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 public List\u0026lt;Advisor\u0026gt; findAdvisorBeans() { // è·å– advisorNames String[] advisorNames = this.cachedAdvisorBeanNames; if (advisorNames == null) { // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let the auto-proxy creator apply to them! advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors( this.beanFactory, Advisor.class, true, false); this.cachedAdvisorBeanNames = advisorNames; } if (advisorNames.length == 0) { return new ArrayList\u0026lt;\u0026gt;(); } // ä¸æ–­ä» Factory ä¸­å» getBean() List\u0026lt;Advisor\u0026gt; advisors = new ArrayList\u0026lt;\u0026gt;(); for (String name : advisorNames) { if (isEligibleBean(name)) { if (this.beanFactory.isCurrentlyInCreation(name)) { if (logger.isTraceEnabled()) { logger.trace(\u0026#34;Skipping currently created advisor \u0026#39;\u0026#34; + name + \u0026#34;\u0026#39;\u0026#34;); } } else { try { advisors.add(this.beanFactory.getBean(name, Advisor.class)); } catch (BeanCreationException ex) { // ...... } } } } return advisors; } æœ€ç»ˆåœ¨ BeanFactoryAdvisorRetrievalHelper ä¸­ï¼Œè·å–åˆ°äº†æ‰€æœ‰çš„ advisorã€‚ å¯¹äºæ²¡æœ‰æŒ‡å®š targetSource çš„ Beanï¼ŒAbstractAdvisorAutoProxyCreator ä¸ä¼šå¯¹å…¶è¿›è¡Œä»»ä½•æ“ä½œï¼Œè€Œæ˜¯åªè¿›è¡Œäº† Advisor çš„åˆå§‹åŒ–ã€‚\nåˆ›å»ºä»£ç†ç±» ä» createBean() æ–¹æ³•å¼€å§‹ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ä»£ç†ç±»å…·ä½“æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼š\n1 2 3 4 5 6 org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) =\u0026gt; org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) doCreateBean å°±æ˜¯å®é™…ä¸Šåˆ›å»º Bean çš„æ–¹æ³•ï¼Œå½“ Bean è¢«å®ä¾‹åŒ–å®Œæˆä¹‹åï¼Œä¼šæ‰§è¡Œ Bean çš„åˆå§‹åŒ–ï¼Œå½“å…¶åˆå§‹åŒ–ç»“æŸä¹‹åï¼Œå°±ä¼šæ‰§è¡Œ AbstractAdvisorAutoProxyCreator å®ç°çš„å¦ä¸€ä¸ªé‡è¦æ–¹æ³•ï¼Œä»£ç†ç±»çš„æ„å»ºå°±æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ã€‚ =\u0026gt; `org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) =\u0026gt; `org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName) è¿™ä¸ªæ–¹æ³•ä¼šæ‰§è¡Œæ‰€æœ‰çš„ BeanPostProcessor çš„ postProcessAfterInitialization() æ–¹æ³•ï¼ŒAbstractAdvisorAutoProxyCreator ä¸­çš„è¿™ä¸ªæ–¹æ³•å°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 @Override public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) { if (bean != null) { Object cacheKey = getCacheKey(bean.getClass(), beanName); if (this.earlyProxyReferences.remove(cacheKey) != bean) { return wrapIfNecessary(bean, beanName, cacheKey); } } return bean; } ","date":"2024-11-15T00:00:00Z","image":"http://localhost:64097/p/spring-%E4%BB%A3%E7%90%86%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/image_hu6850457685914377867.png","permalink":"http://localhost:64097/p/spring-%E4%BB%A3%E7%90%86%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/","title":"Spring ä»£ç†ç±»åˆ›å»ºæµç¨‹æ¢³ç†"},{"content":"å‰è¨€ AOPï¼šæ„ä¸ºé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œé€šè¿‡é¢„ç¼–è¯‘çš„æ–¹å¼å’Œè¿è¡ŒæœŸé—´åŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½åŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤ã€‚\næ—¢ç„¶è¦å®ç° AOP å°±ä¸€å®šç¦»ä¸å¼€ä»£ç†ï¼ŒSpring ä¸­ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼šCgLib åŠ¨æ€ä»£ç†å’Œ AOP åŠ¨æ€ä»£ç†ï¼Œè¿˜é€šè¿‡å¼•å…¥ AspectJ æ¥ç®€åŒ–åˆ‡é¢ç¼–ç¨‹ã€‚\nAOP æ‰§è¡Œè¿‡ç¨‹å¯ä»¥ç®€å•ç†è§£ä¸ºå¯¹ åˆ‡ç‚¹(JointPoint) æ‰§è¡Œ é€šçŸ¥(Advice) ä¸­å®šä¹‰çš„é€»è¾‘ï¼Œè¿™å°±å¼•å‡ºä¸¤ä¸ªæ ¸å¿ƒçš„é—®é¢˜éœ€è¦è§£å†³ï¼š\né€šçŸ¥åœ¨ä½•å¤„æ‰§è¡Œï¼Ÿ å¦‚ä½•åˆ¤æ–­å½“å‰æ‰§è¡Œçš„æ–¹æ³•æ˜¯å¦ç¬¦åˆåˆ‡ç‚¹é€»è¾‘ï¼Ÿ åŠ¨æ€ä»£ç†å¯ä»¥è®©æˆ‘ä»¬è‡ªç”±çš„åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥è‡ªå·±çš„é€»è¾‘ï¼Œè¿™å°±è§£å†³äº†é€šçŸ¥åœ¨ä½•å¤„æ‰§è¡Œçš„é—®é¢˜ï¼›\nä½†æ˜¯åŠ¨æ€ä»£ç†ï¼ˆæ— è®ºæ˜¯ JDKProxy çš„ invoke() è¿˜æ˜¯ CgLib çš„ interctpt()ï¼‰éƒ½æ˜¯åœ¨è¢«ä»£ç†çš„ç±»ä¸­çš„ä»»ä½•æ–¹æ³•æ‰§è¡Œå‰æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦éœ€è¦æ‰§è¡Œåˆ‡ç‚¹é€»è¾‘éœ€è¦æˆ‘ä»¬æ¥å®ç°ã€‚\nå›¾ä¾‹\nä¸Šé¢å±•ç¤ºçš„æ˜¯ä¸€ä¸ªä»£ç†ç±»å¤„ç† AOP çš„é€»è¾‘ï¼Œå…¶ä¸­ MethodInterceptor æ˜¯æ–¹æ³•æ‰§è¡Œå‰çš„ä¸€ä¸ªæ‹¦æˆªå™¨ï¼›MethodMatcher æ˜¯ä¸€ä¸ªæ–¹æ³•åŒ¹é…å™¨ï¼Œé€šè¿‡å®ƒæ¥åˆ¤æ–­æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„æ–¹æ³•ä¹‹å‰æ˜¯å¦éœ€è¦å¤„ç†ä»£ç†é€»è¾‘ï¼› å¦‚æœè¢«ä»£ç†çš„æ–¹æ³•ç¬¦åˆåˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œåˆ™æŒ‰ç…§é¡ºåºæ‰§è¡Œå®šä¹‰çš„ä»£ç†é€»è¾‘ï¼Œè¿™æ ·ä¸€ä¸ªç®€å•çš„ AOP é€»è¾‘å°±æ‰“é€šäº†ã€‚\næ¡ˆä¾‹ æ¡ˆä¾‹å‡†å¤‡ 1 2 3 4 5 6 7 8 9 10 11 public class UserService implements IUserService { public void queryUserName(String uId) { System.out.println(\u0026#34;æŸ¥è¯¢ç”¨æˆ·åç§°ä¸ºï¼šryan\u0026#34;); } public void queryUserId(String name) { System.out.println(\u0026#34;æŸ¥è¯¢ç”¨æˆ·IDä¸ºï¼š10001\u0026#34;); } } è¢«ä»£ç†çš„ UserService ç±»ã€‚\nå®šä¹‰æ–¹æ³•åŒ¹é…å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 class MethodMatcherImpl implements MethodMatcher { private final PointcutExpression pointcutExpression; MethodMatcherImpl(String expression) { PointcutParser parser = PointcutParser.getPointcutParserSupportingAllPrimitivesAndUsingContextClassloaderForResolution(); pointcutExpression = parser.parsePointcutExpression(expression); } @Override public boolean matches(Method method, Class\u0026lt;?\u0026gt; aClass) { return pointcutExpression.matchesMethodExecution(method).alwaysMatches(); } @Override public boolean matches(Method method, Class\u0026lt;?\u0026gt; aClass, Object[] objects) { return false; } @Override public boolean isRuntime() { return false; } } è¿™æ˜¯ä¸€ä¸ªæ–¹æ³•åŒ¹é…ç±»ï¼Œç”¨äºæ£€æµ‹è¾“å…¥çš„æ–¹æ³•æ˜¯å¦ç¬¦åˆåˆ‡ç‚¹è¡¨è¾¾å¼ å®šä¹‰æ–¹æ³•æ‹¦æˆªå™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 class CgLibInterceptor implements MethodInterceptor { private final Object target; private final MethodMatcher methodMatcher; CgLibInterceptor(Object target, String expression) { this.methodMatcher = new MethodMatcherImpl(expression); this.target = target; } @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable { if (methodMatcher.matches(method, target.getClass())) { System.out.println(\u0026#34;cglibä»£ç†ï¼šæ‰§è¡Œåˆ‡é¢é€»è¾‘\u0026#34;); return methodProxy.invoke(target, objects); } return methodProxy.invoke(target, objects); } } æä¾›ç»™ CgLib çš„ CallBack ç±»ï¼Œæ ¹æ®æ–¹æ³•æ˜¯å¦åŒ¹é…åˆ‡ç‚¹è¡¨è¾¾å¼æ¥å†³å®šæ˜¯å¦æ‰§è¡Œåˆ‡é¢é€»è¾‘ã€‚ åˆ›å»ºä»£ç†ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class ProxyTest { final static UserService target = new UserService(); public static void main(String[] args) throws IOException, InterruptedException { Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(UserService.class); enhancer.setCallback(new CgLibInterceptor(target, \u0026#34;execution(* com.ryan.aop_test.service.impl.UserService.queryUserName(..))\u0026#34;)); UserService proxyService = (UserService) enhancer.create(); proxyService.queryUserName(\u0026#34;10001\u0026#34;); System.out.println(\u0026#34;======\u0026#34;); proxyService.queryUserId(\u0026#34;ryan\u0026#34;); } } æµ‹è¯•ç±»ï¼Œè¿™é‡Œä½¿ç”¨åˆ‡ç‚¹è¡¨è¾¾å¼åŒ¹é… UserService ç±»ä¸­çš„ queryUserName æ–¹æ³• è¾“å‡ºæ¡ˆä¾‹ä¸­ï¼Œä¹Ÿåªæœ‰è¿™ä¸ªæ–¹æ³•ä¼šè¢«ä»£ç† è¾“å‡ºç»“æœ\n1 2 3 4 cglibä»£ç† æŸ¥è¯¢ç”¨æˆ·åç§°ä¸ºï¼šryan ====== æŸ¥è¯¢ç”¨æˆ·IDä¸ºï¼š10001 ","date":"2024-11-12T00:00:00Z","image":"http://localhost:64097/p/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-aop-%E5%88%87%E9%9D%A2/pawel-czerwinski-8uZPynIu-rQ-unsplash_hu6307248181568134095.jpg","permalink":"http://localhost:64097/p/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-aop-%E5%88%87%E9%9D%A2/","title":"å®ç°ä¸€ä¸ªç®€å•çš„ AOP åˆ‡é¢"},{"content":"ä»€ä¹ˆæ˜¯ AOPï¼Ÿ AOPï¼ˆAspect Oriented Programmingï¼‰ï¼Œæ„ä¸ºé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œé€šè¿‡é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤çš„ä¸€ç§æŠ€æœ¯ã€‚\nAOPæ˜¯OOPçš„å»¶ç»­ï¼Œæ˜¯è½¯ä»¶å¼€å‘ä¸­çš„ä¸€ä¸ªçƒ­ç‚¹ï¼Œä¹Ÿæ˜¯ Spring æ¡†æ¶ä¸­çš„ä¸€ä¸ªé‡è¦å†…å®¹ï¼Œæ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„ä¸€ç§è¡ç”ŸèŒƒå‹ã€‚\nåˆ©ç”¨AOPå¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚\nä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨æ¯æ¬¡è°ƒç”¨ä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•ä¹‹å‰è¾“å‡ºä¸€ä¸ªæ—¥å¿—,é‚£å¦‚æœæˆ‘ä»¬è¦åœ¨è¿™äº›æ–¹æ³•ä¹‹å‰åŠ ä¸€ä¸ªé‰´æƒå‘¢ï¼ŸåŒæ ·ï¼ŒæŒ‰ç…§å‰é¢çš„æ–¹å¼ï¼Œæ— éå°±æ˜¯å¤š copy ä¸€æ¬¡å˜›\nå°±è¿™æ ·ï¼Œé€šè¿‡å¤šé‡ copy çš„æ–¹å¼ï¼Œæœ€ç»ˆå®Œæˆäº†è¿™ä¸ªä¸šåŠ¡ï¼Œè€Œè¿™ä¹Ÿå°±ä»£è¡¨ç€ï¼Œæ¯æ¬¡æ‰©å±•æ–°çš„æ–¹æ³•ï¼Œä½ éƒ½è¦å»è¿›è¡Œ n æ¬¡å¤åˆ¶ç²˜è´´ï¼›æ¯æ¬¡è¦æ›´æ”¹é‰´æƒæˆ–è€…æ—¥å¿—çš„é€»è¾‘ï¼Œä½ éƒ½è¦å»è¿›è¡Œ n æ¬¡å¤åˆ¶ç²˜è´´ï¼›æ¯æ¬¡ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\nå¬èµ·æ¥éƒ½è®©äººéå¸¸å¤´å¤§ï¼Œä½†å¦‚æœæˆ‘ä»¬å°†é€»è¾‘æ”¹æˆè¿™æ ·å‘¢ï¼Ÿ\nç°åœ¨æ¥çœ‹çœ‹ AOP èƒ½å®ç°æ€æ ·çš„æ•ˆæœï¼š\nè¿™æ ·ï¼Œæˆ‘ä»¬è™½ç„¶æ¯æ¬¡éƒ½ä¸ç”¨å»å¤åˆ¶ä»£ç äº†ï¼Œä½†è¿˜æ˜¯éœ€è¦åœ¨æˆ‘ä»¬éœ€è¦çš„ä½ç½®å»è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œè€Œè°ƒç”¨è¿™ä¸ªä»£ç çš„ä½ç½®å…¶å®å°±æ˜¯Â åˆ‡é¢ã€‚æˆ‘ä»¬ç”¨å…·ä½“çš„ä»£ç æ¥çœ‹ä¸€ä¸‹ï¼Œä¸‹é¢å®ç°äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ BeforeAdviceï¼Œç„¶ååœ¨æ¯ä¸ªæ–¹æ³•ä¹‹å‰å»è°ƒç”¨å®ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public interface BeforeAdvice { void before(); } public class LoggingBeforeAdvice implements BeforeAdvice { @Override public void before() { System.out.println(\u0026#34;æ–¹æ³•è°ƒç”¨ä¹‹å‰çš„æ—¥å¿—\u0026#34;); } } public class MyService { private BeforeAdvice beforeAdvice = new LoggingBeforeAdvice(); public void myMethodA() { beforeAdvice.before(); // ä¸šåŠ¡é€»è¾‘ System.out.println(\u0026#34;æ‰§è¡Œ myMethod1A\u0026#34;); } public void myMethodB() { beforeAdvice.before(); // ä¸šåŠ¡é€»è¾‘ System.out.println(\u0026#34;æ‰§è¡Œ myMethodB\u0026#34;); } } AOP æ ¸å¿ƒæ¦‚å¿µ è¿æ¥ç‚¹ï¼ˆJoin Pointï¼‰ï¼šè¿æ¥ç‚¹æ˜¯ç¨‹åºæ‰§è¡Œä¸­çš„ä¸€ä¸ªç‚¹ï¼Œè¿™ä¸ªç‚¹å¯ä»¥æ˜¯æ–¹æ³•è°ƒç”¨ã€æ–¹æ³•æ‰§è¡Œã€å¼‚å¸¸æŠ›å‡ºç­‰ã€‚åœ¨ Spring AOP ä¸­ï¼Œè¿æ¥ç‚¹ä¸»è¦æ˜¯æŒ‡æ–¹æ³•çš„è°ƒç”¨æˆ–æ‰§è¡Œã€‚è¿æ¥ç‚¹æ˜¯é€šçŸ¥çš„å®é™…åº”ç”¨ç‚¹ã€‚\nåˆ‡ç‚¹ï¼ˆPointCutï¼‰ï¼šç”±äºè¿æ¥ç‚¹å¯èƒ½å¾ˆå¤šï¼ˆæ¯”å¦‚ä¸€ä¸ªç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼‰ï¼Œæƒ³è¦æŠŠæ‰€æœ‰è¿æ¥ç‚¹ç½—åˆ—å‡ºç°æ˜¾ç„¶æœ‰äº›å›°éš¾ï¼›åˆ‡ç‚¹æ˜¯ä¸€ä¸ªå®šä¹‰ï¼Œå†³å®šäº† åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨åˆ‡é¢é€»è¾‘ã€‚ åˆ‡ç‚¹é€šè¿‡åˆ‡ç‚¹è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ï¼šexecution(* com.example.service..(..))ï¼‰æ¥æŒ‡å®šåŒ¹é…çš„æ–¹æ³•å’Œç±»ã€‚åˆ‡ç‚¹è¡¨è¾¾å¼ç”¨äºç­›é€‰è¿æ¥ç‚¹ï¼Œä½¿å¾—é€šçŸ¥åªåœ¨ç‰¹å®šçš„è¿æ¥ç‚¹ä¸Šæ‰§è¡Œã€‚\né€šçŸ¥ï¼ˆAdviceï¼‰ï¼šé€šçŸ¥æ˜¯åœ¨åˆ‡ç‚¹å¤„æ‰§è¡Œçš„ä»£ç ã€‚é€šçŸ¥å®šä¹‰äº†å…·ä½“çš„æ¨ªåˆ‡é€»è¾‘ï¼Œå†³å®šäº†åœ¨æ–¹æ³•æ‰§è¡Œçš„ä»€ä¹ˆé˜¶æ®µï¼ˆä¹‹å‰ã€ä¹‹åã€ç¯ç»•ç­‰ï¼‰æ’å…¥æ¨ªåˆ‡é€»è¾‘ã€‚é€šçŸ¥æœ‰äº”ç§ç±»å‹ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€éƒ¨åˆ†è¿›è¡Œè¯¦ç»†çš„äº†è§£ï¼›é€šçŸ¥å°±æ˜¯åœ¨ ä½•æ—¶ æ‰§è¡Œ æ€æ · çš„é€»è¾‘ã€‚\nåˆ‡é¢ï¼ˆAspectï¼‰ï¼šåˆ‡é¢æ˜¯ AOP çš„æ ¸å¿ƒæ¨¡å—ï¼Œå®ƒå°è£…äº†è·¨è¶Šå¤šä¸ªç±»çš„å…³æ³¨ç‚¹ï¼Œä¾‹å¦‚æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†æˆ–å®‰å…¨æ§åˆ¶ã€‚åˆ‡é¢é€šè¿‡é€šçŸ¥ï¼ˆAdviceï¼‰å’Œåˆ‡ç‚¹ï¼ˆPointcutï¼‰æ¥å®šä¹‰åœ¨ä½•æ—¶ã€ä½•åœ°åº”ç”¨è¿™äº›å…³æ³¨ç‚¹ï¼›å¯ä»¥å°†åˆ‡é¢çœ‹ä½œæ˜¯åˆ‡ç‚¹ï¼ˆPointcutï¼‰å’Œé€šçŸ¥ï¼ˆAdviceï¼‰çš„ç»„åˆã€‚ åˆ‡é¢å®šä¹‰äº†åœ¨ä½•å¤„ï¼ˆåˆ‡ç‚¹ï¼‰ä»¥åŠä½•æ—¶ï¼ˆé€šçŸ¥ï¼‰åº”ç”¨æ¨ªåˆ‡é€»è¾‘ã€‚\näº”ç§é€šçŸ¥ç±»å‹ å‰ç½®é€šçŸ¥ï¼ˆBefore Adviceï¼‰ åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„é€šçŸ¥ã€‚å¯ä»¥ç”¨æ¥æ‰§è¡Œæ—¥å¿—è®°å½•ã€å®‰å…¨æ£€æŸ¥ç­‰ã€‚\n1 2 3 4 5 6 7 8 @Aspect @Component public class LoggingAspect { @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) public void beforeAdvice() { System.out.println(\u0026#34;å‰ç½®é€šçŸ¥ï¼šæ–¹æ³•è°ƒç”¨ä¹‹å‰æ‰§è¡Œ\u0026#34;); } } åç½®é€šçŸ¥ï¼ˆAfter Adviceï¼‰ åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œçš„é€šçŸ¥ï¼Œæ— è®ºæ–¹æ³•æ˜¯æˆåŠŸè¿”å›è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚å¸¸ç”¨äºæ¸…ç†èµ„æºç­‰ã€‚\n1 2 3 4 5 6 7 8 @Aspect @Component public class LoggingAspect { @After(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) public void afterAdvice() { System.out.println(\u0026#34;åç½®é€šçŸ¥ï¼šæ–¹æ³•è°ƒç”¨ä¹‹åæ‰§è¡Œ\u0026#34;); } } è¿”å›åé€šçŸ¥ï¼ˆAfter Returning Adviceï¼‰ åœ¨ç›®æ ‡æ–¹æ³•æˆåŠŸè¿”å›ç»“æœä¹‹åæ‰§è¡Œçš„é€šçŸ¥ã€‚å¯ä»¥ç”¨æ¥è®°å½•è¿”å›å€¼æˆ–å¯¹è¿”å›å€¼è¿›è¡Œå¤„ç†ã€‚\n1 2 3 4 5 6 7 8 @Aspect @Component public class LoggingAspect { @AfterReturning(pointcut = \u0026#34;execution(* com.example.service.*.*(..))\u0026#34;, returning = \u0026#34;result\u0026#34;) public void afterReturningAdvice(Object result) { System.out.println(\u0026#34;è¿”å›åé€šçŸ¥ï¼šæ–¹æ³•è¿”å›å€¼ä¸º \u0026#34; + result); } } æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼ˆAfter Throwing Adviceï¼‰ åœ¨ç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åæ‰§è¡Œçš„é€šçŸ¥ã€‚å¯ä»¥ç”¨æ¥è®°å½•å¼‚å¸¸ä¿¡æ¯æˆ–æ‰§è¡Œå¼‚å¸¸å¤„ç†é€»è¾‘ã€‚\n1 2 3 4 5 6 7 8 @Aspect @Component public class LoggingAspect { @AfterThrowing(pointcut = \u0026#34;execution(* com.example.service.*.*(..))\u0026#34;, throwing = \u0026#34;exception\u0026#34;) public void afterThrowingAdvice(Exception exception) { System.out.println(\u0026#34;æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼šå¼‚å¸¸ä¸º \u0026#34; + exception.getMessage()); } } ç¯ç»•é€šçŸ¥ï¼ˆAround Adviceï¼‰ ç¯ç»•é€šçŸ¥åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œçš„å‰åéƒ½æ‰§è¡Œï¼Œå¯ä»¥å®Œå…¨æ§åˆ¶ç›®æ ‡æ–¹æ³•çš„æ‰§è¡Œï¼ŒåŒ…æ‹¬å†³å®šæ˜¯å¦æ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼Œä»¥åŠåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰åæ·»åŠ è‡ªå®šä¹‰é€»è¾‘ã€‚ç¯ç»•é€šçŸ¥æœ€ä¸ºå¼ºå¤§å’Œçµæ´»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 @Aspect @Component public class LoggingAspect { @Around(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) public Object aroundAdvice(ProceedingJoinPoint joinPoint) throws Throwable { System.out.println(\u0026#34;ç¯ç»•é€šçŸ¥ï¼šæ–¹æ³•è°ƒç”¨ä¹‹å‰\u0026#34;); Object result = joinPoint.proceed(); // æ‰§è¡Œç›®æ ‡æ–¹æ³• System.out.println(\u0026#34;ç¯ç»•é€šçŸ¥ï¼šæ–¹æ³•è°ƒç”¨ä¹‹å\u0026#34;); return result; } } è¿™äº”ç§é€šçŸ¥ç±»å‹çš„æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š å‰ç½®é€šçŸ¥ï¼ˆBefore Adviceï¼‰ ç¯ç»•é€šçŸ¥ï¼ˆAround Adviceï¼‰çš„å‰åŠéƒ¨åˆ† ç›®æ ‡æ–¹æ³•æ‰§è¡Œ ç¯ç»•é€šçŸ¥ï¼ˆAround Adviceï¼‰çš„ååŠéƒ¨åˆ† è¿”å›åé€šçŸ¥ï¼ˆAfter Returning Adviceï¼‰ï¼ˆå¦‚æœç›®æ ‡æ–¹æ³•æˆåŠŸè¿”å›ï¼‰ æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼ˆAfter Throwing Adviceï¼‰ï¼ˆå¦‚æœç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼‰ åç½®é€šçŸ¥ï¼ˆAfter Adviceï¼‰\n","date":"2024-10-09T00:00:00Z","image":"http://localhost:64097/p/aop-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/the-creative-exchange-d2zvqp3fpro-unsplash_hu5876398126655421130.jpg","permalink":"http://localhost:64097/p/aop-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/","title":"AOP æ ¸å¿ƒæ¦‚å¿µ"}]